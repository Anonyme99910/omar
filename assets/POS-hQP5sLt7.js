import{b as he,r as l,g as j,h as xe,c as i,o as r,d as t,j as V,e as y,k as q,v as b,l as u,F as I,m as N,p as _e,t as p,s as O,x as we,w as ae,y as g}from"./index-BKD5Oar3.js";import{f as z,t as L}from"./numbers-BTmV-EI5.js";import{S as ke}from"./search-tVddhkwB.js";import{P as Ce}from"./package-4y2w8aTf.js";import{c as oe}from"./createLucideIcon-C2Kbf_sm.js";import{P as qe}from"./plus-BCw8-tgt.js";import{T as Pe}from"./trash-2-xN52SsB0.js";import{U as Se}from"./user-plus-ByWbdjTZ.js";/**
 * @license lucide-vue-next v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const $e=oe("MinusIcon",[["path",{d:"M5 12h14",key:"1ays0h"}]]);/**
 * @license lucide-vue-next v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Me=oe("ShoppingCartIcon",[["circle",{cx:"8",cy:"21",r:"1",key:"jimo8o"}],["circle",{cx:"19",cy:"21",r:"1",key:"13723u"}],["path",{d:"M2.05 2.05h2l2.66 12.42a2 2 0 0 0 2 1.58h9.78a2 2 0 0 0 1.95-1.57l1.65-7.43H5.12",key:"9zh506"}]]),Fe={class:"grid grid-cols-1 lg:grid-cols-3 gap-6"},je={class:"lg:col-span-2 space-y-4"},Ve={class:"card"},ze={class:"relative"},Le={key:0,class:"absolute left-12 top-3.5"},Ue={class:"grid grid-cols-2 md:grid-cols-3 gap-4"},Te=["onClick"],De={class:"aspect-square bg-gray-100 rounded-lg mb-3 flex items-center justify-center overflow-hidden"},Ie=["src","alt"],Ne={class:"font-bold text-gray-900 mb-1 truncate"},Ae={class:"text-sm text-gray-500 mb-2"},Be={class:"flex items-center justify-between"},Qe={class:"text-lg font-bold text-primary-600"},Ee={class:"space-y-4"},Oe={class:"card sticky top-24"},We={class:"text-xl font-bold mb-4 flex items-center gap-2"},Je={class:"space-y-3 mb-4 max-h-64 overflow-y-auto"},He={key:0,class:"text-center py-8 text-gray-500"},Re={class:"flex-1"},Ge={class:"font-medium text-sm"},Ke={class:"text-xs text-gray-500"},Xe={class:"flex items-center gap-2"},Ye=["onClick"],Ze={class:"w-8 text-center font-bold"},et=["onClick"],tt=["onClick"],st={class:"mb-4"},at={class:"flex gap-2"},ot={class:"flex-1 relative"},nt={key:0,class:"absolute z-50 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-y-auto"},lt=["onMousedown"],rt={class:"font-medium"},ut={class:"text-sm text-gray-600"},it={class:"border-t pt-4 space-y-2"},ct={class:"flex justify-between text-sm"},dt={class:"font-bold"},pt={class:"flex justify-between text-sm"},vt={class:"flex justify-between text-sm"},mt={class:"flex justify-between text-lg font-bold border-t pt-2"},ft={class:"text-primary-600"},yt={class:"flex justify-between text-sm bg-blue-50 p-2 rounded"},bt=["placeholder"],gt={key:0,class:"flex justify-between text-sm text-red-600 font-bold"},ht={class:"mt-4"},xt={class:"grid grid-cols-3 gap-2"},_t=["onClick"],wt={class:"mt-4 space-y-2"},kt=["disabled"],Ct={class:"bg-white rounded-xl p-6 w-full max-w-md"},qt={class:"flex gap-3"},Ut={__name:"POS",setup(Pt){const c=he(),m=l([]),U=l([]),f=l([]),d=l([]),T=l(""),h=l(""),x=l("");l("");const _=l(0),w=l(0),P=l(null),A=l("cash"),S=l(!1),$=l(!1),B=l(!1);let Q=null;const k=l({name:"",phone:""}),ne=[{value:"cash",label:"نقدي"},{value:"card",label:"بطاقة"},{value:"transfer",label:"تحويل"}],le=j(()=>T.value?m.value:m.value.slice(0,12)),W=j(()=>{if(!h.value)return f.value;const a=h.value.toLowerCase().trim();return f.value.filter(e=>{const s=e.name.toLowerCase(),n=e.phone.toString();if(s.includes(a)||n.includes(a))return!0;let o=0;for(let v=0;v<s.length&&o<a.length;v++)s[v]===a[o]&&o++;return o===a.length}).slice(0,10)}),J=j(()=>d.value.reduce((a,e)=>a+e.unit_price*e.quantity,0)),M=j(()=>J.value+w.value-_.value),H=j(()=>{const a=P.value||M.value;return Math.max(0,M.value-a)}),re=()=>{Q&&clearTimeout(Q),B.value=!0,Q=setTimeout(async()=>{await ue(),B.value=!1},300)},ue=async()=>{const a=T.value.trim();if(!a){m.value=U.value.slice(0,12);return}const e=a.toLowerCase(),s=U.value.filter(n=>{var Y,Z,ee,te,se;const o=n.name_ar.toLowerCase(),v=((Y=n.barcode)==null?void 0:Y.toLowerCase())||"",F=((ee=(Z=n.category)==null?void 0:Z.name_ar)==null?void 0:ee.toLowerCase())||"",D=((se=(te=n.brand)==null?void 0:te.name_ar)==null?void 0:se.toLowerCase())||"";if(o.includes(e)||v.includes(e)||F.includes(e)||D.includes(e))return!0;let C=0;for(let E=0;E<o.length&&C<e.length;E++)o[E]===e[C]&&C++;return C===e.length});if(m.value=s,s.length===0&&a.length>=2)try{const n=await g.getProducts({search:a});m.value=n.data.data||n.data||[]}catch(n){console.error("Search error:",n)}},ie=()=>{$.value=!0},R=a=>{if(x.value=a,a){const e=f.value.find(s=>s.id===a);e&&(h.value=`${e.name} - ${L(e.phone)}`)}else h.value="عميل عادي";$.value=!1},ce=()=>{setTimeout(()=>{$.value=!1},200)},G=a=>{const e=f.value.find(n=>n.id===x.value),s=(e==null?void 0:e.segment)||"قطاعي";return parseFloat(s==="جملة"?a.price_جملة:s==="صفحة"?a.price_صفحة:a.price_قطاعي)},de=a=>{if(a.quantity===0){c.error("المنتج غير متوفر في المخزون");return}const e=d.value.find(s=>s.product.id===a.id);if(e){if(e.quantity>=a.quantity){c.error("الكمية المطلوبة غير متوفرة");return}e.quantity++}else d.value.push({product:a,quantity:1,unit_price:G(a)});c.success("تم إضافة المنتج للسلة")},pe=a=>{if(a.quantity>=a.product.quantity){c.error("الكمية المطلوبة غير متوفرة");return}a.quantity++},ve=a=>{a.quantity>1?a.quantity--:K(a)},K=a=>{d.value=d.value.filter(e=>e.product.id!==a.product.id)},me=()=>{d.value.length!==0&&confirm("هل أنت متأكد من مسح السلة؟")&&(d.value=[],_.value=0,w.value=0)},fe=async()=>{try{const a=await g.createCustomer(k.value);c.success("تم إضافة العميل بنجاح"),f.value.push(a.data),x.value=a.data.id,S.value=!1,k.value={name:"",phone:""}}catch{c.error("فشل إضافة العميل")}},ye=async()=>{var e,s,n;if(d.value.length===0)return;const a={customer_id:x.value||null,items:d.value.map(o=>({product_id:o.product.id,quantity:o.quantity,unit_price:o.unit_price})),tax:w.value,discount:_.value,paid_amount:P.value||M.value,payment_method:A.value};try{const o=await g.createSale(a),v=L(o.data.invoice_number);c.success(`تم إنشاء الفاتورة ${v}`);const F=[];if(confirm("هل تريد تحميل الفاتورة PDF؟"))try{await g.downloadInvoicePdf(o.data.id),c.success("تم تحميل الفاتورة بنجاح")}catch(D){console.error("PDF Error:",D),c.error("فشل تحميل الفاتورة PDF")}(e=o.data.customer)!=null&&e.phone&&confirm("هل تريد مشاركة الفاتورة عبر واتساب؟")&&be(o.data),d.value=[],_.value=0,w.value=0,P.value=null,x.value="",X()}catch(o){c.error(((n=(s=o.response)==null?void 0:s.data)==null?void 0:n.error)||"فشل إنشاء الفاتورة")}},be=async a=>{var e,s,n;try{const o=await g.getWhatsAppMessage(a.id),{message:v,phone:F}=o.data;if(!F){c.error("لا يوجد رقم هاتف للعميل");return}const C=`https://wa.me/${F.replace(/[^0-9]/g,"")}?text=${encodeURIComponent(v)}`;window.open(C,"_blank"),c.success("تم فتح واتساب بنجاح")}catch(o){console.error("WhatsApp Error:",o),console.error("Error details:",(e=o.response)==null?void 0:e.data),c.error("فشل مشاركة الفاتورة عبر واتساب: "+(((n=(s=o.response)==null?void 0:s.data)==null?void 0:n.message)||o.message))}},X=async()=>{try{const a=await g.getProducts(),e=a.data.data||a.data||[];U.value=e,m.value=e}catch(a){console.error("Failed to load products:",a),U.value=[],m.value=[]}},ge=async()=>{try{const a=await g.getCustomers();f.value=a.data.data||a.data||[]}catch(a){console.error("Failed to load customers:",a),f.value=[]}};return xe(()=>{X(),ge()}),(a,e)=>(r(),i("div",Fe,[t("div",je,[t("div",Ve,[t("div",ze,[y(t("input",{"onUpdate:modelValue":e[0]||(e[0]=s=>T.value=s),onInput:re,type:"text",placeholder:"ابحث بالاسم أو الباركود أو الفئة...",class:"input pl-10 text-lg",autofocus:""},null,544),[[b,T.value]]),q(u(ke),{class:"absolute left-3 top-3.5 text-gray-400",size:24}),B.value?(r(),i("div",Le,[...e[12]||(e[12]=[t("div",{class:"animate-spin rounded-full h-5 w-5 border-b-2 border-primary-600"},null,-1)])])):V("",!0)])]),t("div",Ue,[(r(!0),i(I,null,N(le.value,s=>(r(),i("div",{key:s.id,onClick:n=>de(s),class:"card hover:shadow-lg cursor-pointer transition-all hover:scale-105"},[t("div",De,[s.photos&&JSON.parse(s.photos)[0]?(r(),i("img",{key:0,src:`http://localhost/parfumes/backend/public${JSON.parse(s.photos)[0]}`,alt:s.name_ar,class:"w-full h-full object-cover"},null,8,Ie)):(r(),_e(u(Ce),{key:1,size:48,class:"text-gray-400"}))]),t("h4",Ne,p(s.name_ar),1),t("p",Ae,p(s.volume_ml),1),t("div",Be,[t("span",Qe,p(u(z)(G(s))),1),t("span",{class:O(["text-xs badge",s.quantity>0?"badge-success":"badge-danger"])},p(u(L)(s.quantity))+" قطعة ",3)])],8,Te))),128))])]),t("div",Ee,[t("div",Oe,[t("h3",We,[q(u(Me),{size:24}),e[13]||(e[13]=we(" سلة المشتريات ",-1))]),t("div",Je,[d.value.length===0?(r(),i("div",He," السلة فارغة ")):V("",!0),(r(!0),i(I,null,N(d.value,s=>(r(),i("div",{key:s.product.id,class:"flex items-center gap-3 p-3 bg-gray-50 rounded-lg"},[t("div",Re,[t("p",Ge,p(s.product.name_ar),1),t("p",Ke,p(u(z)(s.unit_price)),1)]),t("div",Xe,[t("button",{onClick:n=>ve(s),class:"w-7 h-7 rounded bg-gray-200 hover:bg-gray-300"},[q(u($e),{size:16,class:"mx-auto"})],8,Ye),t("span",Ze,p(u(L)(s.quantity)),1),t("button",{onClick:n=>pe(s),class:"w-7 h-7 rounded bg-gray-200 hover:bg-gray-300"},[q(u(qe),{size:16,class:"mx-auto"})],8,et)]),t("button",{onClick:n=>K(s),class:"text-red-600 hover:text-red-800"},[q(u(Pe),{size:18})],8,tt)]))),128))]),t("div",st,[e[15]||(e[15]=t("label",{class:"block text-sm font-medium mb-2"},"العميل (اختياري)",-1)),t("div",at,[t("div",ot,[y(t("input",{"onUpdate:modelValue":e[1]||(e[1]=s=>h.value=s),onInput:ie,onFocus:e[2]||(e[2]=s=>$.value=!0),onBlur:ce,type:"text",placeholder:"ابحث عن عميل أو اختر عميل عادي...",class:"input"},null,544),[[b,h.value]]),$.value&&W.value.length>0?(r(),i("div",nt,[t("div",{onMousedown:e[3]||(e[3]=s=>R("")),class:"px-4 py-2 hover:bg-gray-100 cursor-pointer border-b"},[...e[14]||(e[14]=[t("span",{class:"font-medium"},"عميل عادي",-1)])],32),(r(!0),i(I,null,N(W.value,s=>(r(),i("div",{key:s.id,onMousedown:n=>R(s.id),class:O(["px-4 py-2 hover:bg-primary-50 cursor-pointer transition-colors",{"bg-primary-100":x.value===s.id}])},[t("div",rt,p(s.name),1),t("div",ut,p(u(L)(s.phone)),1)],42,lt))),128))])):V("",!0)]),t("button",{onClick:e[4]||(e[4]=s=>S.value=!0),class:"btn btn-secondary"},[q(u(Se),{size:18})])])]),t("div",it,[t("div",ct,[e[16]||(e[16]=t("span",null,"المجموع الفرعي:",-1)),t("span",dt,p(u(z)(J.value)),1)]),t("div",pt,[e[17]||(e[17]=t("span",null,"الخصم:",-1)),y(t("input",{"onUpdate:modelValue":e[5]||(e[5]=s=>_.value=s),type:"number",step:"0.01",class:"input w-32 text-left py-1"},null,512),[[b,_.value,void 0,{number:!0}]])]),t("div",vt,[e[18]||(e[18]=t("span",null,"الضريبة:",-1)),y(t("input",{"onUpdate:modelValue":e[6]||(e[6]=s=>w.value=s),type:"number",step:"0.01",class:"input w-32 text-left py-1"},null,512),[[b,w.value,void 0,{number:!0}]])]),t("div",mt,[e[19]||(e[19]=t("span",null,"الإجمالي:",-1)),t("span",ft,p(u(z)(M.value)),1)]),t("div",yt,[e[20]||(e[20]=t("span",null,"المبلغ المدفوع:",-1)),y(t("input",{"onUpdate:modelValue":e[7]||(e[7]=s=>P.value=s),type:"number",step:"0.01",placeholder:M.value.toString(),class:"input w-32 text-left py-1"},null,8,bt),[[b,P.value,void 0,{number:!0}]])]),H.value>0?(r(),i("div",gt,[e[21]||(e[21]=t("span",null,"المتبقي:",-1)),t("span",null,p(u(z)(H.value)),1)])):V("",!0)]),t("div",ht,[e[22]||(e[22]=t("label",{class:"block text-sm font-medium mb-2"},"طريقة الدفع",-1)),t("div",xt,[(r(),i(I,null,N(ne,s=>t("button",{key:s.value,onClick:n=>A.value=s.value,class:O([A.value===s.value?"bg-primary-600 text-white":"bg-gray-100","py-2 rounded-lg font-medium transition-all"])},p(s.label),11,_t)),64))])]),t("div",wt,[t("button",{onClick:ye,disabled:d.value.length===0,class:"btn btn-success w-full py-3 text-lg"}," إتمام البيع ",8,kt),t("button",{onClick:me,class:"btn btn-secondary w-full"}," مسح السلة ")])])]),S.value?(r(),i("div",{key:0,class:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",onClick:e[11]||(e[11]=ae(s=>S.value=!1,["self"]))},[t("div",Ct,[e[26]||(e[26]=t("h3",{class:"text-2xl font-bold mb-4"},"إضافة عميل",-1)),t("form",{onSubmit:ae(fe,["prevent"]),class:"space-y-4"},[t("div",null,[e[23]||(e[23]=t("label",{class:"block text-sm font-medium mb-2"},"الاسم *",-1)),y(t("input",{"onUpdate:modelValue":e[8]||(e[8]=s=>k.value.name=s),type:"text",required:"",class:"input"},null,512),[[b,k.value.name]])]),t("div",null,[e[24]||(e[24]=t("label",{class:"block text-sm font-medium mb-2"},"رقم الهاتف *",-1)),y(t("input",{"onUpdate:modelValue":e[9]||(e[9]=s=>k.value.phone=s),type:"tel",required:"",class:"input"},null,512),[[b,k.value.phone]])]),t("div",qt,[t("button",{type:"button",onClick:e[10]||(e[10]=s=>S.value=!1),class:"btn btn-secondary flex-1"},"إلغاء"),e[25]||(e[25]=t("button",{type:"submit",class:"btn btn-primary flex-1"},"حفظ",-1))])],32)])])):V("",!0)]))}};export{Ut as default};
