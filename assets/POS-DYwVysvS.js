import{b as xe,r as l,g as U,h as _e,c as i,o as r,d as s,j,e as y,k as q,v as b,l as u,F as I,m as N,p as we,t as p,s as W,x as ke,w as oe,y as h}from"./index-CE3e7UPr.js";import{f as V,t as z}from"./numbers-BTmV-EI5.js";import{S as Ce}from"./search-B6VDws8f.js";import{P as qe}from"./package--001L_Gk.js";import{c as ae}from"./createLucideIcon-BVti9HEL.js";import{P as Pe}from"./plus-DdPd5rwY.js";import{T as Se}from"./trash-2-Wwonpwq2.js";import{U as $e}from"./user-plus-D9t8o8_q.js";/**
 * @license lucide-vue-next v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Me=ae("MinusIcon",[["path",{d:"M5 12h14",key:"1ays0h"}]]);/**
 * @license lucide-vue-next v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Fe=ae("ShoppingCartIcon",[["circle",{cx:"8",cy:"21",r:"1",key:"jimo8o"}],["circle",{cx:"19",cy:"21",r:"1",key:"13723u"}],["path",{d:"M2.05 2.05h2l2.66 12.42a2 2 0 0 0 2 1.58h9.78a2 2 0 0 0 1.95-1.57l1.65-7.43H5.12",key:"9zh506"}]]),Ue={class:"grid grid-cols-1 lg:grid-cols-3 gap-6"},je={class:"lg:col-span-2 space-y-4"},Ve={class:"card"},ze={class:"relative"},Le={key:0,class:"absolute left-12 top-3.5"},Te={class:"grid grid-cols-2 md:grid-cols-3 gap-4"},De=["onClick"],Ie={class:"aspect-square bg-gray-100 rounded-lg mb-3 flex items-center justify-center overflow-hidden"},Ne=["src","alt"],Ae={class:"font-bold text-gray-900 mb-1 truncate"},Be={class:"text-sm text-gray-500 mb-2"},Qe={class:"flex items-center justify-between"},Ee={class:"text-lg font-bold text-primary-600"},We={class:"space-y-4"},Oe={class:"card sticky top-24"},Je={class:"text-xl font-bold mb-4 flex items-center gap-2"},He={class:"space-y-3 mb-4 max-h-64 overflow-y-auto"},Re={key:0,class:"text-center py-8 text-gray-500"},Ge={class:"flex-1"},Ke={class:"font-medium text-sm"},Xe={class:"text-xs text-gray-500"},Ye={class:"flex items-center gap-2"},Ze=["onClick"],et={class:"w-8 text-center font-bold"},tt=["onClick"],st=["onClick"],ot={class:"mb-4"},at={class:"flex gap-2"},nt={class:"flex-1 relative"},lt={key:0,class:"absolute z-50 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-y-auto"},rt=["onMousedown"],ut={class:"font-medium"},it={class:"text-sm text-gray-600"},ct={class:"border-t pt-4 space-y-2"},dt={class:"flex justify-between text-sm"},pt={class:"font-bold"},vt={class:"flex justify-between text-sm"},mt={class:"flex justify-between text-sm"},ft={class:"flex justify-between text-lg font-bold border-t pt-2"},yt={class:"text-primary-600"},bt={class:"flex justify-between text-sm bg-blue-50 p-2 rounded"},ht=["placeholder"],gt={key:0,class:"flex justify-between text-sm text-red-600 font-bold"},xt={class:"mt-4"},_t={class:"grid grid-cols-3 gap-2"},wt=["onClick"],kt={class:"mt-4 space-y-2"},Ct=["disabled"],qt={class:"bg-white rounded-xl p-6 w-full max-w-md"},Pt={class:"flex gap-3"},Tt={__name:"POS",setup(St){const c=xe(),m=l([]),L=l([]),f=l([]),d=l([]),T=l(""),g=l(""),x=l("");l("");const _=l(0),w=l(0),P=l(null),A=l("cash"),S=l(!1),$=l(!1),B=l(!1);let Q=null;const k=l({name:"",phone:""}),ne=[{value:"cash",label:"نقدي"},{value:"card",label:"بطاقة"},{value:"transfer",label:"تحويل"}],le=U(()=>T.value?m.value:m.value.slice(0,12)),O=U(()=>{if(!g.value)return f.value;const o=g.value.toLowerCase().trim();return f.value.filter(e=>{const t=e.name.toLowerCase(),n=e.phone.toString();if(t.includes(o)||n.includes(o))return!0;let a=0;for(let v=0;v<t.length&&a<o.length;v++)t[v]===o[a]&&a++;return a===o.length}).slice(0,10)}),J=U(()=>d.value.reduce((o,e)=>o+e.unit_price*e.quantity,0)),M=U(()=>J.value+w.value-_.value),H=U(()=>{const o=P.value||M.value;return Math.max(0,M.value-o)}),re=()=>{Q&&clearTimeout(Q),B.value=!0,Q=setTimeout(async()=>{await ue(),B.value=!1},300)},ue=async()=>{const o=T.value.trim();if(!o){m.value=L.value.slice(0,12);return}const e=o.toLowerCase(),t=L.value.filter(n=>{var Y,Z,ee,te,se;const a=n.name_ar.toLowerCase(),v=((Y=n.barcode)==null?void 0:Y.toLowerCase())||"",F=((ee=(Z=n.category)==null?void 0:Z.name_ar)==null?void 0:ee.toLowerCase())||"",D=((se=(te=n.brand)==null?void 0:te.name_ar)==null?void 0:se.toLowerCase())||"";if(a.includes(e)||v.includes(e)||F.includes(e)||D.includes(e))return!0;let C=0;for(let E=0;E<a.length&&C<e.length;E++)a[E]===e[C]&&C++;return C===e.length});if(m.value=t,t.length===0&&o.length>=2)try{const n=await h.getProducts({search:o});m.value=n.data.data||n.data||[]}catch(n){console.error("Search error:",n)}},ie=()=>{$.value=!0},R=o=>{if(x.value=o,o){const e=f.value.find(t=>t.id===o);e&&(g.value=`${e.name} - ${z(e.phone)}`)}else g.value="عميل عادي";$.value=!1},ce=()=>{setTimeout(()=>{$.value=!1},200)},de=o=>{if(!o)return"";const t=JSON.parse(o)[0];return t.startsWith("data:")?t:`http://localhost/parfumes/backend/public${t}`},G=o=>{const e=f.value.find(n=>n.id===x.value),t=(e==null?void 0:e.segment)||"قطاعي";return parseFloat(t==="جملة"?o.price_جملة:t==="صفحة"?o.price_صفحة:o.price_قطاعي)},pe=o=>{if(o.quantity===0){c.error("المنتج غير متوفر في المخزون");return}const e=d.value.find(t=>t.product.id===o.id);if(e){if(e.quantity>=o.quantity){c.error("الكمية المطلوبة غير متوفرة");return}e.quantity++}else d.value.push({product:o,quantity:1,unit_price:G(o)});c.success("تم إضافة المنتج للسلة")},ve=o=>{if(o.quantity>=o.product.quantity){c.error("الكمية المطلوبة غير متوفرة");return}o.quantity++},me=o=>{o.quantity>1?o.quantity--:K(o)},K=o=>{d.value=d.value.filter(e=>e.product.id!==o.product.id)},fe=()=>{d.value.length!==0&&confirm("هل أنت متأكد من مسح السلة؟")&&(d.value=[],_.value=0,w.value=0)},ye=async()=>{try{const o=await h.createCustomer(k.value);c.success("تم إضافة العميل بنجاح"),f.value.push(o.data),x.value=o.data.id,S.value=!1,k.value={name:"",phone:""}}catch{c.error("فشل إضافة العميل")}},be=async()=>{var e,t,n;if(d.value.length===0)return;const o={customer_id:x.value||null,items:d.value.map(a=>({product_id:a.product.id,quantity:a.quantity,unit_price:a.unit_price})),tax:w.value,discount:_.value,paid_amount:P.value||M.value,payment_method:A.value};try{const a=await h.createSale(o),v=z(a.data.invoice_number);c.success(`تم إنشاء الفاتورة ${v}`);const F=[];if(confirm("هل تريد تحميل الفاتورة PDF؟"))try{await h.downloadInvoicePdf(a.data.id),c.success("تم تحميل الفاتورة بنجاح")}catch(D){console.error("PDF Error:",D),c.error("فشل تحميل الفاتورة PDF")}(e=a.data.customer)!=null&&e.phone&&confirm("هل تريد مشاركة الفاتورة عبر واتساب؟")&&he(a.data),d.value=[],_.value=0,w.value=0,P.value=null,x.value="",X()}catch(a){c.error(((n=(t=a.response)==null?void 0:t.data)==null?void 0:n.error)||"فشل إنشاء الفاتورة")}},he=async o=>{var e,t,n;try{const a=await h.getWhatsAppMessage(o.id),{message:v,phone:F}=a.data;if(!F){c.error("لا يوجد رقم هاتف للعميل");return}const C=`https://wa.me/${F.replace(/[^0-9]/g,"")}?text=${encodeURIComponent(v)}`;window.open(C,"_blank"),c.success("تم فتح واتساب بنجاح")}catch(a){console.error("WhatsApp Error:",a),console.error("Error details:",(e=a.response)==null?void 0:e.data),c.error("فشل مشاركة الفاتورة عبر واتساب: "+(((n=(t=a.response)==null?void 0:t.data)==null?void 0:n.message)||a.message))}},X=async()=>{try{const o=await h.getProducts(),e=o.data.data||o.data||[];L.value=e,m.value=e}catch(o){console.error("Failed to load products:",o),L.value=[],m.value=[]}},ge=async()=>{try{const o=await h.getCustomers();f.value=o.data.data||o.data||[]}catch(o){console.error("Failed to load customers:",o),f.value=[]}};return _e(()=>{X(),ge()}),(o,e)=>(r(),i("div",Ue,[s("div",je,[s("div",Ve,[s("div",ze,[y(s("input",{"onUpdate:modelValue":e[0]||(e[0]=t=>T.value=t),onInput:re,type:"text",placeholder:"ابحث بالاسم أو الباركود أو الفئة...",class:"input pl-10 text-lg",autofocus:""},null,544),[[b,T.value]]),q(u(Ce),{class:"absolute left-3 top-3.5 text-gray-400",size:24}),B.value?(r(),i("div",Le,[...e[12]||(e[12]=[s("div",{class:"animate-spin rounded-full h-5 w-5 border-b-2 border-primary-600"},null,-1)])])):j("",!0)])]),s("div",Te,[(r(!0),i(I,null,N(le.value,t=>(r(),i("div",{key:t.id,onClick:n=>pe(t),class:"card hover:shadow-lg cursor-pointer transition-all hover:scale-105"},[s("div",Ie,[t.photos&&JSON.parse(t.photos)[0]?(r(),i("img",{key:0,src:de(t.photos),alt:t.name_ar,class:"w-full h-full object-cover"},null,8,Ne)):(r(),we(u(qe),{key:1,size:48,class:"text-gray-400"}))]),s("h4",Ae,p(t.name_ar),1),s("p",Be,p(t.volume_ml),1),s("div",Qe,[s("span",Ee,p(u(V)(G(t))),1),s("span",{class:W(["text-xs badge",t.quantity>0?"badge-success":"badge-danger"])},p(u(z)(t.quantity))+" قطعة ",3)])],8,De))),128))])]),s("div",We,[s("div",Oe,[s("h3",Je,[q(u(Fe),{size:24}),e[13]||(e[13]=ke(" سلة المشتريات ",-1))]),s("div",He,[d.value.length===0?(r(),i("div",Re," السلة فارغة ")):j("",!0),(r(!0),i(I,null,N(d.value,t=>(r(),i("div",{key:t.product.id,class:"flex items-center gap-3 p-3 bg-gray-50 rounded-lg"},[s("div",Ge,[s("p",Ke,p(t.product.name_ar),1),s("p",Xe,p(u(V)(t.unit_price)),1)]),s("div",Ye,[s("button",{onClick:n=>me(t),class:"w-7 h-7 rounded bg-gray-200 hover:bg-gray-300"},[q(u(Me),{size:16,class:"mx-auto"})],8,Ze),s("span",et,p(u(z)(t.quantity)),1),s("button",{onClick:n=>ve(t),class:"w-7 h-7 rounded bg-gray-200 hover:bg-gray-300"},[q(u(Pe),{size:16,class:"mx-auto"})],8,tt)]),s("button",{onClick:n=>K(t),class:"text-red-600 hover:text-red-800"},[q(u(Se),{size:18})],8,st)]))),128))]),s("div",ot,[e[15]||(e[15]=s("label",{class:"block text-sm font-medium mb-2"},"العميل (اختياري)",-1)),s("div",at,[s("div",nt,[y(s("input",{"onUpdate:modelValue":e[1]||(e[1]=t=>g.value=t),onInput:ie,onFocus:e[2]||(e[2]=t=>$.value=!0),onBlur:ce,type:"text",placeholder:"ابحث عن عميل أو اختر عميل عادي...",class:"input"},null,544),[[b,g.value]]),$.value&&O.value.length>0?(r(),i("div",lt,[s("div",{onMousedown:e[3]||(e[3]=t=>R("")),class:"px-4 py-2 hover:bg-gray-100 cursor-pointer border-b"},[...e[14]||(e[14]=[s("span",{class:"font-medium"},"عميل عادي",-1)])],32),(r(!0),i(I,null,N(O.value,t=>(r(),i("div",{key:t.id,onMousedown:n=>R(t.id),class:W(["px-4 py-2 hover:bg-primary-50 cursor-pointer transition-colors",{"bg-primary-100":x.value===t.id}])},[s("div",ut,p(t.name),1),s("div",it,p(u(z)(t.phone)),1)],42,rt))),128))])):j("",!0)]),s("button",{onClick:e[4]||(e[4]=t=>S.value=!0),class:"btn btn-secondary"},[q(u($e),{size:18})])])]),s("div",ct,[s("div",dt,[e[16]||(e[16]=s("span",null,"المجموع الفرعي:",-1)),s("span",pt,p(u(V)(J.value)),1)]),s("div",vt,[e[17]||(e[17]=s("span",null,"الخصم:",-1)),y(s("input",{"onUpdate:modelValue":e[5]||(e[5]=t=>_.value=t),type:"number",step:"0.01",class:"input w-32 text-left py-1"},null,512),[[b,_.value,void 0,{number:!0}]])]),s("div",mt,[e[18]||(e[18]=s("span",null,"الضريبة:",-1)),y(s("input",{"onUpdate:modelValue":e[6]||(e[6]=t=>w.value=t),type:"number",step:"0.01",class:"input w-32 text-left py-1"},null,512),[[b,w.value,void 0,{number:!0}]])]),s("div",ft,[e[19]||(e[19]=s("span",null,"الإجمالي:",-1)),s("span",yt,p(u(V)(M.value)),1)]),s("div",bt,[e[20]||(e[20]=s("span",null,"المبلغ المدفوع:",-1)),y(s("input",{"onUpdate:modelValue":e[7]||(e[7]=t=>P.value=t),type:"number",step:"0.01",placeholder:M.value.toString(),class:"input w-32 text-left py-1"},null,8,ht),[[b,P.value,void 0,{number:!0}]])]),H.value>0?(r(),i("div",gt,[e[21]||(e[21]=s("span",null,"المتبقي:",-1)),s("span",null,p(u(V)(H.value)),1)])):j("",!0)]),s("div",xt,[e[22]||(e[22]=s("label",{class:"block text-sm font-medium mb-2"},"طريقة الدفع",-1)),s("div",_t,[(r(),i(I,null,N(ne,t=>s("button",{key:t.value,onClick:n=>A.value=t.value,class:W([A.value===t.value?"bg-primary-600 text-white":"bg-gray-100","py-2 rounded-lg font-medium transition-all"])},p(t.label),11,wt)),64))])]),s("div",kt,[s("button",{onClick:be,disabled:d.value.length===0,class:"btn btn-success w-full py-3 text-lg"}," إتمام البيع ",8,Ct),s("button",{onClick:fe,class:"btn btn-secondary w-full"}," مسح السلة ")])])]),S.value?(r(),i("div",{key:0,class:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",onClick:e[11]||(e[11]=oe(t=>S.value=!1,["self"]))},[s("div",qt,[e[26]||(e[26]=s("h3",{class:"text-2xl font-bold mb-4"},"إضافة عميل",-1)),s("form",{onSubmit:oe(ye,["prevent"]),class:"space-y-4"},[s("div",null,[e[23]||(e[23]=s("label",{class:"block text-sm font-medium mb-2"},"الاسم *",-1)),y(s("input",{"onUpdate:modelValue":e[8]||(e[8]=t=>k.value.name=t),type:"text",required:"",class:"input"},null,512),[[b,k.value.name]])]),s("div",null,[e[24]||(e[24]=s("label",{class:"block text-sm font-medium mb-2"},"رقم الهاتف *",-1)),y(s("input",{"onUpdate:modelValue":e[9]||(e[9]=t=>k.value.phone=t),type:"tel",required:"",class:"input"},null,512),[[b,k.value.phone]])]),s("div",Pt,[s("button",{type:"button",onClick:e[10]||(e[10]=t=>S.value=!1),class:"btn btn-secondary flex-1"},"إلغاء"),e[25]||(e[25]=s("button",{type:"submit",class:"btn btn-primary flex-1"},"حفظ",-1))])],32)])])):j("",!0)]))}};export{Tt as default};
