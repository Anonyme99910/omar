import{b as ge,r as l,g as j,h as he,c as d,o as c,d as t,j as z,e as y,k as f,v as b,l as r,F as I,m as N,t as p,s as W,x as xe,w as se,y as g}from"./index-BtufX_AP.js";import{f as L,t as U}from"./numbers-BTmV-EI5.js";import{S as _e}from"./search-CZARMqRq.js";import{P as we}from"./package-CNDypgr3.js";import{c as oe}from"./createLucideIcon-DVJE_DOM.js";import{P as ke}from"./plus-BEMk8ZDL.js";import{T as Ce}from"./trash-2-CMxptB_L.js";import{U as qe}from"./user-plus-DizNV21F.js";/**
 * @license lucide-vue-next v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Pe=oe("MinusIcon",[["path",{d:"M5 12h14",key:"1ays0h"}]]);/**
 * @license lucide-vue-next v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Se=oe("ShoppingCartIcon",[["circle",{cx:"8",cy:"21",r:"1",key:"jimo8o"}],["circle",{cx:"19",cy:"21",r:"1",key:"13723u"}],["path",{d:"M2.05 2.05h2l2.66 12.42a2 2 0 0 0 2 1.58h9.78a2 2 0 0 0 1.95-1.57l1.65-7.43H5.12",key:"9zh506"}]]),$e={class:"grid grid-cols-1 lg:grid-cols-3 gap-6"},Me={class:"lg:col-span-2 space-y-4"},Ve={class:"card"},je={class:"relative"},ze={key:0,class:"absolute left-12 top-3.5"},Le={class:"grid grid-cols-2 md:grid-cols-3 gap-4"},Ue=["onClick"],Fe={class:"aspect-square bg-gray-100 rounded-lg mb-3 flex items-center justify-center"},Te={class:"font-bold text-gray-900 mb-1 truncate"},De={class:"text-sm text-gray-500 mb-2"},Ie={class:"flex items-center justify-between"},Ne={class:"text-lg font-bold text-primary-600"},Ae={class:"space-y-4"},Qe={class:"card sticky top-24"},Be={class:"text-xl font-bold mb-4 flex items-center gap-2"},Ee={class:"space-y-3 mb-4 max-h-64 overflow-y-auto"},We={key:0,class:"text-center py-8 text-gray-500"},He={class:"flex-1"},Oe={class:"font-medium text-sm"},Re={class:"text-xs text-gray-500"},Ge={class:"flex items-center gap-2"},Je=["onClick"],Ke={class:"w-8 text-center font-bold"},Xe=["onClick"],Ye=["onClick"],Ze={class:"mb-4"},et={class:"flex gap-2"},tt={class:"flex-1 relative"},st={key:0,class:"absolute z-50 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-y-auto"},ot=["onMousedown"],at={class:"font-medium"},nt={class:"text-sm text-gray-600"},lt={class:"border-t pt-4 space-y-2"},rt={class:"flex justify-between text-sm"},ut={class:"font-bold"},it={class:"flex justify-between text-sm"},dt={class:"flex justify-between text-sm"},ct={class:"flex justify-between text-lg font-bold border-t pt-2"},pt={class:"text-primary-600"},vt={class:"flex justify-between text-sm bg-blue-50 p-2 rounded"},mt=["placeholder"],yt={key:0,class:"flex justify-between text-sm text-red-600 font-bold"},ft={class:"mt-4"},bt={class:"grid grid-cols-3 gap-2"},gt=["onClick"],ht={class:"mt-4 space-y-2"},xt=["disabled"],_t={class:"bg-white rounded-xl p-6 w-full max-w-md"},wt={class:"flex gap-3"},zt={__name:"POS",setup(kt){const u=ge(),m=l([]),F=l([]),h=l([]),i=l([]),T=l(""),x=l(""),q=l("");l("");const _=l(0),w=l(0),P=l(null),A=l("cash"),S=l(!1),$=l(!1),Q=l(!1);let B=null;const k=l({name:"",phone:""}),ae=[{value:"cash",label:"نقدي"},{value:"card",label:"بطاقة"},{value:"transfer",label:"تحويل"}],ne=j(()=>T.value?m.value:m.value.slice(0,12)),H=j(()=>{if(!x.value)return h.value;const o=x.value.toLowerCase().trim();return h.value.filter(e=>{const s=e.name.toLowerCase(),n=e.phone.toString();if(s.includes(o)||n.includes(o))return!0;let a=0;for(let v=0;v<s.length&&a<o.length;v++)s[v]===o[a]&&a++;return a===o.length}).slice(0,10)}),O=j(()=>i.value.reduce((o,e)=>o+e.product.selling_price*e.quantity,0)),M=j(()=>O.value+w.value-_.value),R=j(()=>{const o=P.value||M.value;return Math.max(0,M.value-o)}),le=()=>{B&&clearTimeout(B),Q.value=!0,B=setTimeout(async()=>{await re(),Q.value=!1},300)},re=async()=>{const o=T.value.trim();if(!o){m.value=F.value.slice(0,12);return}const e=o.toLowerCase(),s=F.value.filter(n=>{var X,Y,Z,ee,te;const a=n.name_ar.toLowerCase(),v=((X=n.barcode)==null?void 0:X.toLowerCase())||"",V=((Z=(Y=n.category)==null?void 0:Y.name_ar)==null?void 0:Z.toLowerCase())||"",D=((te=(ee=n.brand)==null?void 0:ee.name_ar)==null?void 0:te.toLowerCase())||"";if(a.includes(e)||v.includes(e)||V.includes(e)||D.includes(e))return!0;let C=0;for(let E=0;E<a.length&&C<e.length;E++)a[E]===e[C]&&C++;return C===e.length});if(m.value=s,s.length===0&&o.length>=2)try{const n=await g.getProducts({search:o});m.value=n.data.data||n.data||[]}catch(n){console.error("Search error:",n)}},ue=()=>{$.value=!0},G=o=>{if(q.value=o,o){const e=h.value.find(s=>s.id===o);e&&(x.value=`${e.name} - ${U(e.phone)}`)}else x.value="عميل عادي";$.value=!1},ie=()=>{setTimeout(()=>{$.value=!1},200)},de=o=>{if(o.stock_quantity===0){u.error("المنتج غير متوفر في المخزون");return}const e=i.value.find(s=>s.product.id===o.id);if(e){if(e.quantity>=o.stock_quantity){u.error("الكمية المطلوبة غير متوفرة");return}e.quantity++}else i.value.push({product:o,quantity:1});u.success("تم إضافة المنتج للسلة")},ce=o=>{if(o.quantity>=o.product.stock_quantity){u.error("الكمية المطلوبة غير متوفرة");return}o.quantity++},pe=o=>{o.quantity>1?o.quantity--:J(o)},J=o=>{i.value=i.value.filter(e=>e.product.id!==o.product.id)},ve=()=>{i.value.length!==0&&confirm("هل أنت متأكد من مسح السلة؟")&&(i.value=[],_.value=0,w.value=0)},me=async()=>{try{const o=await g.createCustomer(k.value);u.success("تم إضافة العميل بنجاح"),h.value.push(o.data),q.value=o.data.id,S.value=!1,k.value={name:"",phone:""}}catch{u.error("فشل إضافة العميل")}},ye=async()=>{var e,s,n;if(i.value.length===0)return;const o={customer_id:q.value||null,items:i.value.map(a=>({product_id:a.product.id,quantity:a.quantity,unit_price:a.product.selling_price})),tax:w.value,discount:_.value,paid_amount:P.value||M.value,payment_method:A.value};try{const a=await g.createSale(o),v=U(a.data.invoice_number);u.success(`تم إنشاء الفاتورة ${v}`);const V=[];if(confirm("هل تريد تحميل الفاتورة PDF؟"))try{await g.downloadInvoicePdf(a.data.id),u.success("تم تحميل الفاتورة بنجاح")}catch(D){console.error("PDF Error:",D),u.error("فشل تحميل الفاتورة PDF")}(e=a.data.customer)!=null&&e.phone&&confirm("هل تريد مشاركة الفاتورة عبر واتساب؟")&&fe(a.data),i.value=[],_.value=0,w.value=0,P.value=null,q.value="",K()}catch(a){u.error(((n=(s=a.response)==null?void 0:s.data)==null?void 0:n.error)||"فشل إنشاء الفاتورة")}},fe=async o=>{var e,s,n;try{const a=await g.getWhatsAppMessage(o.id),{message:v,phone:V}=a.data;if(!V){u.error("لا يوجد رقم هاتف للعميل");return}const C=`https://wa.me/${V.replace(/[^0-9]/g,"")}?text=${encodeURIComponent(v)}`;window.open(C,"_blank"),u.success("تم فتح واتساب بنجاح")}catch(a){console.error("WhatsApp Error:",a),console.error("Error details:",(e=a.response)==null?void 0:e.data),u.error("فشل مشاركة الفاتورة عبر واتساب: "+(((n=(s=a.response)==null?void 0:s.data)==null?void 0:n.message)||a.message))}},K=async()=>{try{const o=await g.getProducts(),e=o.data.data||o.data||[];F.value=e,m.value=e.slice(0,12)}catch(o){console.error("Failed to load products:",o),F.value=[],m.value=[]}},be=async()=>{try{const o=await g.getCustomers();h.value=o.data.data||o.data||[]}catch(o){console.error("Failed to load customers:",o),h.value=[]}};return he(()=>{K(),be()}),(o,e)=>(c(),d("div",$e,[t("div",Me,[t("div",Ve,[t("div",je,[y(t("input",{"onUpdate:modelValue":e[0]||(e[0]=s=>T.value=s),onInput:le,type:"text",placeholder:"ابحث بالاسم أو الباركود أو الفئة...",class:"input pl-10 text-lg",autofocus:""},null,544),[[b,T.value]]),f(r(_e),{class:"absolute left-3 top-3.5 text-gray-400",size:24}),Q.value?(c(),d("div",ze,[...e[12]||(e[12]=[t("div",{class:"animate-spin rounded-full h-5 w-5 border-b-2 border-primary-600"},null,-1)])])):z("",!0)])]),t("div",Le,[(c(!0),d(I,null,N(ne.value,s=>{var n;return c(),d("div",{key:s.id,onClick:a=>de(s),class:"card hover:shadow-lg cursor-pointer transition-all hover:scale-105"},[t("div",Fe,[f(r(we),{size:48,class:"text-gray-400"})]),t("h4",Te,p(s.name_ar),1),t("p",De,p((n=s.brand)==null?void 0:n.name_ar),1),t("div",Ie,[t("span",Ne,p(r(L)(s.selling_price)),1),t("span",{class:W(["text-xs badge",s.stock_quantity>0?"badge-success":"badge-danger"])},p(r(U)(s.stock_quantity))+" قطعة ",3)])],8,Ue)}),128))])]),t("div",Ae,[t("div",Qe,[t("h3",Be,[f(r(Se),{size:24}),e[13]||(e[13]=xe(" سلة المشتريات ",-1))]),t("div",Ee,[i.value.length===0?(c(),d("div",We," السلة فارغة ")):z("",!0),(c(!0),d(I,null,N(i.value,s=>(c(),d("div",{key:s.product.id,class:"flex items-center gap-3 p-3 bg-gray-50 rounded-lg"},[t("div",He,[t("p",Oe,p(s.product.name_ar),1),t("p",Re,p(r(L)(s.product.selling_price)),1)]),t("div",Ge,[t("button",{onClick:n=>pe(s),class:"w-7 h-7 rounded bg-gray-200 hover:bg-gray-300"},[f(r(Pe),{size:16,class:"mx-auto"})],8,Je),t("span",Ke,p(r(U)(s.quantity)),1),t("button",{onClick:n=>ce(s),class:"w-7 h-7 rounded bg-gray-200 hover:bg-gray-300"},[f(r(ke),{size:16,class:"mx-auto"})],8,Xe)]),t("button",{onClick:n=>J(s),class:"text-red-600 hover:text-red-800"},[f(r(Ce),{size:18})],8,Ye)]))),128))]),t("div",Ze,[e[15]||(e[15]=t("label",{class:"block text-sm font-medium mb-2"},"العميل (اختياري)",-1)),t("div",et,[t("div",tt,[y(t("input",{"onUpdate:modelValue":e[1]||(e[1]=s=>x.value=s),onInput:ue,onFocus:e[2]||(e[2]=s=>$.value=!0),onBlur:ie,type:"text",placeholder:"ابحث عن عميل أو اختر عميل عادي...",class:"input"},null,544),[[b,x.value]]),$.value&&H.value.length>0?(c(),d("div",st,[t("div",{onMousedown:e[3]||(e[3]=s=>G("")),class:"px-4 py-2 hover:bg-gray-100 cursor-pointer border-b"},[...e[14]||(e[14]=[t("span",{class:"font-medium"},"عميل عادي",-1)])],32),(c(!0),d(I,null,N(H.value,s=>(c(),d("div",{key:s.id,onMousedown:n=>G(s.id),class:W(["px-4 py-2 hover:bg-primary-50 cursor-pointer transition-colors",{"bg-primary-100":q.value===s.id}])},[t("div",at,p(s.name),1),t("div",nt,p(r(U)(s.phone)),1)],42,ot))),128))])):z("",!0)]),t("button",{onClick:e[4]||(e[4]=s=>S.value=!0),class:"btn btn-secondary"},[f(r(qe),{size:18})])])]),t("div",lt,[t("div",rt,[e[16]||(e[16]=t("span",null,"المجموع الفرعي:",-1)),t("span",ut,p(r(L)(O.value)),1)]),t("div",it,[e[17]||(e[17]=t("span",null,"الخصم:",-1)),y(t("input",{"onUpdate:modelValue":e[5]||(e[5]=s=>_.value=s),type:"number",step:"0.01",class:"input w-32 text-left py-1"},null,512),[[b,_.value,void 0,{number:!0}]])]),t("div",dt,[e[18]||(e[18]=t("span",null,"الضريبة:",-1)),y(t("input",{"onUpdate:modelValue":e[6]||(e[6]=s=>w.value=s),type:"number",step:"0.01",class:"input w-32 text-left py-1"},null,512),[[b,w.value,void 0,{number:!0}]])]),t("div",ct,[e[19]||(e[19]=t("span",null,"الإجمالي:",-1)),t("span",pt,p(r(L)(M.value)),1)]),t("div",vt,[e[20]||(e[20]=t("span",null,"المبلغ المدفوع:",-1)),y(t("input",{"onUpdate:modelValue":e[7]||(e[7]=s=>P.value=s),type:"number",step:"0.01",placeholder:M.value.toString(),class:"input w-32 text-left py-1"},null,8,mt),[[b,P.value,void 0,{number:!0}]])]),R.value>0?(c(),d("div",yt,[e[21]||(e[21]=t("span",null,"المتبقي:",-1)),t("span",null,p(r(L)(R.value)),1)])):z("",!0)]),t("div",ft,[e[22]||(e[22]=t("label",{class:"block text-sm font-medium mb-2"},"طريقة الدفع",-1)),t("div",bt,[(c(),d(I,null,N(ae,s=>t("button",{key:s.value,onClick:n=>A.value=s.value,class:W([A.value===s.value?"bg-primary-600 text-white":"bg-gray-100","py-2 rounded-lg font-medium transition-all"])},p(s.label),11,gt)),64))])]),t("div",ht,[t("button",{onClick:ye,disabled:i.value.length===0,class:"btn btn-success w-full py-3 text-lg"}," إتمام البيع ",8,xt),t("button",{onClick:ve,class:"btn btn-secondary w-full"}," مسح السلة ")])])]),S.value?(c(),d("div",{key:0,class:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",onClick:e[11]||(e[11]=se(s=>S.value=!1,["self"]))},[t("div",_t,[e[26]||(e[26]=t("h3",{class:"text-2xl font-bold mb-4"},"إضافة عميل",-1)),t("form",{onSubmit:se(me,["prevent"]),class:"space-y-4"},[t("div",null,[e[23]||(e[23]=t("label",{class:"block text-sm font-medium mb-2"},"الاسم *",-1)),y(t("input",{"onUpdate:modelValue":e[8]||(e[8]=s=>k.value.name=s),type:"text",required:"",class:"input"},null,512),[[b,k.value.name]])]),t("div",null,[e[24]||(e[24]=t("label",{class:"block text-sm font-medium mb-2"},"رقم الهاتف *",-1)),y(t("input",{"onUpdate:modelValue":e[9]||(e[9]=s=>k.value.phone=s),type:"tel",required:"",class:"input"},null,512),[[b,k.value.phone]])]),t("div",wt,[t("button",{type:"button",onClick:e[10]||(e[10]=s=>S.value=!1),class:"btn btn-secondary flex-1"},"إلغاء"),e[25]||(e[25]=t("button",{type:"submit",class:"btn btn-primary flex-1"},"حفظ",-1))])],32)])])):z("",!0)]))}};export{zt as default};
