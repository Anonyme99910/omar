import{b as W,r as p,g as Z,h as tt,c as v,o as g,d as t,j as w,k as x,t as l,l as n,x as M,F as T,m as U,s as A,w as L,e as S,v as E,z as et,B as st,y as D}from"./index-CE3e7UPr.js";import{t as b,f as N}from"./numbers-BTmV-EI5.js";import{A as ot}from"./alert-triangle-BJI92Myh.js";import{P as at}from"./package--001L_Gk.js";import{D as lt}from"./dollar-sign-DfjrDi2W.js";import{P as nt}from"./plus-DdPd5rwY.js";import{E as rt}from"./eye-CFHDh25T.js";import{T as B}from"./trash-2-Wwonpwq2.js";import{X as dt}from"./x-Cw4qPuvh.js";import{c as it}from"./createLucideIcon-BVti9HEL.js";/**
 * @license lucide-vue-next v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ut=it("InfoIcon",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M12 16v-4",key:"1dtifu"}],["path",{d:"M12 8h.01",key:"e9boi3"}]]),ct={class:"space-y-6"},vt={class:"grid grid-cols-1 md:grid-cols-3 gap-6"},gt={class:"card bg-gradient-to-br from-red-500 to-red-600 text-white"},mt={class:"flex items-center justify-between"},pt={class:"text-3xl font-bold mt-2"},bt={class:"card bg-gradient-to-br from-orange-500 to-orange-600 text-white"},yt={class:"flex items-center justify-between"},xt={class:"text-3xl font-bold mt-2"},ft={class:"card bg-gradient-to-br from-gray-600 to-gray-700 text-white"},_t={class:"flex items-center justify-between"},wt={class:"text-2xl font-bold mt-2"},ht={class:"card"},kt={class:"flex items-center justify-between mb-4"},Dt={class:"overflow-x-auto"},qt={class:"table"},Pt={class:"font-mono text-sm"},Ct={class:"font-medium"},Mt={class:"text-xs text-gray-500"},St={class:"badge badge-danger"},$t={class:"badge badge-success"},zt={class:"flex items-center gap-2"},jt=["onClick"],It=["onClick"],Lt={key:0},Et={class:"bg-white rounded-xl p-6 w-full max-w-md"},Ft={class:"flex items-center justify-between mb-4"},Vt={class:"space-y-4"},Tt={class:"flex items-start gap-3 p-3 bg-blue-50 rounded-lg"},Ut={class:"flex-1"},At={class:"font-bold text-gray-800"},Nt={class:"text-sm text-gray-600"},Bt={class:"grid grid-cols-2 gap-4"},Kt={class:"p-3 bg-gray-50 rounded-lg"},Ht={class:"font-semibold"},Rt={class:"p-3 bg-red-50 rounded-lg"},Ot={class:"font-semibold text-red-600"},Qt={class:"grid grid-cols-2 gap-4"},Xt={class:"p-3 bg-gray-50 rounded-lg"},Yt={class:"font-semibold text-green-600"},Gt={class:"p-3 bg-gray-50 rounded-lg"},Jt={class:"font-semibold"},Wt={class:"p-3 bg-yellow-50 rounded-lg"},Zt={class:"font-semibold text-yellow-700"},te={class:"p-3 bg-gray-50 rounded-lg"},ee={class:"font-semibold text-red-600"},se={key:0,class:"p-3 bg-gray-50 rounded-lg"},oe={class:"text-sm"},ae={class:"p-3 bg-gray-50 rounded-lg"},le={class:"text-sm"},ne={class:"mt-6 flex gap-3"},re={class:"bg-white rounded-xl p-6 w-full max-w-md"},de={class:"relative"},ie={key:0,class:"absolute z-50 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-y-auto"},ue=["onMousedown"],ce={class:"font-medium"},ve={class:"text-sm text-gray-600 flex justify-between mt-1"},ge={class:"font-semibold text-green-600"},me={key:0,class:"text-sm text-gray-600 mt-1"},pe={class:"font-bold text-green-600"},be=["max"],Me={__name:"Inventory",setup(ye){const y=W(),q=p([]),P=p([]),r=p(null),C=p({total_damaged:0,total_quantity:0,total_loss:0}),$=p(!1);p(!1);const _=p(""),h=p(!1),m=p(null),d=p({product_id:null,quantity:1,damage_type:"",notes:""}),F=Z(()=>{if(!_.value)return q.value.slice(0,10);const o=_.value.toLowerCase().trim();return q.value.filter(e=>{var c,f;const i=e.name_ar.toLowerCase(),s=((c=e.sku)==null?void 0:c.toLowerCase())||"",a=((f=e.barcode)==null?void 0:f.toLowerCase())||"";if(i.includes(o)||s.includes(o)||a.includes(o))return!0;let u=0;for(let k=0;k<i.length&&u<o.length;k++)i[k]===o[u]&&u++;return u===o.length}).slice(0,10)}),z=async()=>{var o;try{const e=await D.getProducts({per_page:1e3});q.value=e.data.data||e.data||[]}catch(e){if(console.error("Failed to load products:",e),((o=e.response)==null?void 0:o.status)===401)return;y.error("فشل تحميل المنتجات"),q.value=[]}},j=async()=>{try{const o=await D.getDamagedProducts();P.value=o.data||[],await K()}catch(o){console.error("Failed to load damaged products:",o),P.value=[]}},K=async()=>{try{const o=await D.getDamagedStats();C.value=o.data}catch(o){console.error("Failed to load stats:",o)}},H=()=>{h.value=!0},R=o=>{m.value=o,d.value.product_id=o.id,_.value=`${o.name_ar} (${o.sku})`,h.value=!1},O=()=>{setTimeout(()=>{h.value=!1},200)},Q=()=>{d.value={product_id:null,quantity:1,damage_type:"",notes:""},m.value=null,_.value="",$.value=!0},I=()=>{$.value=!1,m.value=null,_.value=""},X=async()=>{var o,e,i,s;try{if(!m.value){y.error("الرجاء اختيار منتج");return}if(!d.value.quantity||d.value.quantity<=0){y.error("الرجاء إدخال كمية صحيحة");return}if(d.value.quantity>m.value.stock_quantity){y.error("الكمية المطلوبة أكبر من المخزون المتاح");return}if(!d.value.damage_type){y.error("الرجاء اختيار نوع التلف");return}try{console.log("Creating damaged product:",{product_id:m.value.id,quantity:d.value.quantity,damage_type:d.value.damage_type,notes:d.value.notes||""});const a=await D.createDamagedProduct({product_id:m.value.id,quantity:d.value.quantity,damage_type:d.value.damage_type,notes:d.value.notes||""});console.log("✅ Damaged product created:",a.data),y.success("✅ تم تسجيل المنتج التالف وخصمه من المخزون"),I(),await z(),await j()}catch(a){console.error("API Error Full:",a),console.error("API Error Response:",a.response),console.error("API Error Data:",(o=a.response)==null?void 0:o.data);let u="فشل في تسجيل المنتج التالف";throw(e=a.response)!=null&&e.data&&(a.response.data.errors?u=Object.values(a.response.data.errors).flat().join(", "):a.response.data.error?u=a.response.data.error:a.response.data.message&&(u=a.response.data.message)),new Error(u)}}catch(a){console.error("Submit Error:",a),y.error(a.message||((s=(i=a.response)==null?void 0:i.data)==null?void 0:s.error)||"فشل تسجيل المنتج التالف")}},Y=o=>({expired:"منتهي الصلاحية",broken:"مكسور/تالف",defective:"معيب من المصنع",water_damage:"تلف بسبب الماء",other:"أخرى"})[o]||o,G=o=>{r.value=o},V=async o=>{var i,s,a,u;const e=`هل أنت متأكد من حذف هذا السجل؟

سيتم استعادة ${o.damaged_quantity} قطعة إلى المخزون`;if(confirm(e))try{const c=await D.deleteDamagedProduct(o.id);console.log("Delete response:",c.data);const f=c.data.message||"تم حذف السجل واستعادة الكمية للمخزون";y.success(`✅ ${f}`),await j(),await z()}catch(c){console.error("Delete error:",c);const f=((s=(i=c.response)==null?void 0:i.data)==null?void 0:s.message)||((u=(a=c.response)==null?void 0:a.data)==null?void 0:u.error)||"فشل حذف السجل";y.error(f)}},J=o=>{try{const e=new Date(o),i=k=>String(k).padStart(2,"0"),s=e.getFullYear(),a=i(e.getMonth()+1),u=i(e.getDate()),c=i(e.getHours()),f=i(e.getMinutes());return`${s}-${a}-${u} ${c}:${f}`}catch{return""}};return tt(()=>{z(),j()}),(o,e)=>{var i;return g(),v("div",ct,[t("div",vt,[t("div",gt,[t("div",mt,[t("div",null,[e[9]||(e[9]=t("p",{class:"text-red-100 text-sm"},"إجمالي المنتجات التالفة",-1)),t("h3",pt,l(n(b)(C.value.total_damaged||0)),1)]),x(n(ot),{size:48,class:"text-red-200"})])]),t("div",bt,[t("div",yt,[t("div",null,[e[10]||(e[10]=t("p",{class:"text-orange-100 text-sm"},"الكمية التالفة",-1)),t("h3",xt,l(n(b)(C.value.total_quantity||0)),1)]),x(n(at),{size:48,class:"text-orange-200"})])]),t("div",ft,[t("div",_t,[t("div",null,[e[11]||(e[11]=t("p",{class:"text-gray-100 text-sm"},"قيمة الخسائر",-1)),t("h3",wt,l(n(N)(C.value.total_loss||0)),1)]),x(n(lt),{size:48,class:"text-gray-200"})])])]),t("div",ht,[t("div",kt,[e[13]||(e[13]=t("h2",{class:"text-2xl font-bold text-gray-800"},"إدارة المنتجات التالفة",-1)),t("button",{onClick:Q,class:"btn btn-danger flex items-center gap-2 whitespace-nowrap"},[x(n(nt),{size:20}),e[12]||(e[12]=M(" تسجيل منتج تالف ",-1))])]),t("div",Dt,[t("table",qt,[e[15]||(e[15]=t("thead",null,[t("tr",null,[t("th",null,"SKU"),t("th",null,"المنتج"),t("th",null,"الفئة"),t("th",null,"الكمية المتضررة"),t("th",null,"حد إعادة الطلب"),t("th",null,"المتاح للبيع"),t("th",null,"الحالة"),t("th",null,"الإجراءات")])],-1)),t("tbody",null,[(g(!0),v(T,null,U(P.value,s=>(g(),v("tr",{key:s.id},[t("td",Pt,l(s.sku),1),t("td",null,[t("div",null,[t("p",Ct,l(s.product_name),1),t("p",Mt,l(s.category_name),1)])]),t("td",null,l(s.category_name),1),t("td",null,[t("span",St,l(n(b)(s.damaged_quantity))+" قطعة ",1)]),t("td",null,l(n(b)(s.reorder_level)),1),t("td",null,[t("span",$t,l(n(b)(s.available_stock))+" قطعة ",1)]),t("td",null,[t("span",{class:A(["badge",s.status==="متوفر"?"badge-success":"badge-warning"])},l(s.status),3)]),t("td",null,[t("div",zt,[t("button",{onClick:a=>G(s),class:"text-blue-600 hover:text-blue-800",title:"عرض التفاصيل"},[x(n(rt),{size:18})],8,jt),t("button",{onClick:a=>V(s),class:"text-red-600 hover:text-red-800",title:"حذف"},[x(n(B),{size:18})],8,It)])])]))),128)),P.value.length===0?(g(),v("tr",Lt,[...e[14]||(e[14]=[t("td",{colspan:"8",class:"text-center py-8 text-gray-500"}," لا توجد منتجات تالفة مسجلة ",-1)])])):w("",!0)])])])]),r.value?(g(),v("div",{key:0,class:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",onClick:e[3]||(e[3]=L(s=>r.value=null,["self"]))},[t("div",Et,[t("div",Ft,[e[16]||(e[16]=t("h3",{class:"text-2xl font-bold text-blue-600"},"تفاصيل المنتج التالف",-1)),t("button",{onClick:e[0]||(e[0]=s=>r.value=null),class:"text-gray-400 hover:text-gray-600"},[x(n(dt),{size:24})])]),t("div",Vt,[t("div",Tt,[x(n(ut),{size:20,class:"text-blue-600 mt-1"}),t("div",Ut,[t("div",At,l(r.value.product_name),1),t("div",Nt,"SKU: "+l(r.value.sku),1)])]),t("div",Bt,[t("div",Kt,[e[17]||(e[17]=t("div",{class:"text-xs text-gray-500 mb-1"},"الفئة",-1)),t("div",Ht,l(r.value.category_name),1)]),t("div",Rt,[e[18]||(e[18]=t("div",{class:"text-xs text-gray-500 mb-1"},"الكمية التالفة",-1)),t("div",Ot,l(n(b)(r.value.damaged_quantity))+" قطعة",1)])]),t("div",Qt,[t("div",Xt,[e[19]||(e[19]=t("div",{class:"text-xs text-gray-500 mb-1"},"المتاح للبيع",-1)),t("div",Yt,l(n(b)(r.value.available_stock))+" قطعة",1)]),t("div",Gt,[e[20]||(e[20]=t("div",{class:"text-xs text-gray-500 mb-1"},"حد إعادة الطلب",-1)),t("div",Jt,l(n(b)(r.value.reorder_level)),1)])]),t("div",Wt,[e[21]||(e[21]=t("div",{class:"text-xs text-gray-500 mb-1"},"نوع التلف",-1)),t("div",Zt,l(Y(r.value.damage_type)),1)]),t("div",te,[e[22]||(e[22]=t("div",{class:"text-xs text-gray-500 mb-1"},"قيمة الخسارة",-1)),t("div",ee,l(n(N)(r.value.total_loss||r.value.cost_price*r.value.damaged_quantity)),1)]),r.value.notes?(g(),v("div",se,[e[23]||(e[23]=t("div",{class:"text-xs text-gray-500 mb-1"},"ملاحظات",-1)),t("div",oe,l(r.value.notes),1)])):w("",!0),t("div",ae,[e[24]||(e[24]=t("div",{class:"text-xs text-gray-500 mb-1"},"تاريخ التسجيل",-1)),t("div",le,l(J(r.value.created_at)),1)])]),t("div",ne,[t("button",{onClick:e[1]||(e[1]=s=>r.value=null),class:"btn btn-secondary flex-1"},"إغلاق"),t("button",{onClick:e[2]||(e[2]=s=>{V(r.value),r.value=null}),class:"btn btn-danger flex-1"},[x(n(B),{size:18,class:"inline"}),e[25]||(e[25]=M(" حذف ",-1))])])])])):w("",!0),$.value?(g(),v("div",{key:1,class:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",onClick:L(I,["self"])},[t("div",re,[e[35]||(e[35]=t("h3",{class:"text-2xl font-bold mb-6 text-red-600"},"تسجيل منتج تالف",-1)),t("form",{onSubmit:L(X,["prevent"]),class:"space-y-4"},[t("div",null,[e[28]||(e[28]=t("label",{class:"block text-sm font-medium mb-2"},"المنتج *",-1)),t("div",de,[S(t("input",{"onUpdate:modelValue":e[4]||(e[4]=s=>_.value=s),onInput:H,onFocus:e[5]||(e[5]=s=>h.value=!0),onBlur:O,type:"text",placeholder:"ابحث عن منتج بالاسم أو SKU...",class:"input",required:""},null,544),[[E,_.value]]),h.value&&F.value.length>0?(g(),v("div",ie,[(g(!0),v(T,null,U(F.value,s=>(g(),v("div",{key:s.id,onMousedown:a=>R(s),class:A(["px-4 py-3 hover:bg-red-50 cursor-pointer transition-colors border-b last:border-b-0",{"bg-red-100":d.value.product_id===s.id}])},[t("div",ce,l(s.name_ar),1),t("div",ve,[t("span",null,"SKU: "+l(s.sku),1),t("span",ge,"المخزون: "+l(n(b)(s.stock_quantity)),1)])],42,ue))),128))])):w("",!0)]),m.value?(g(),v("p",me,[e[26]||(e[26]=M(" المخزون الحالي: ",-1)),t("span",pe,l(n(b)(m.value.stock_quantity)),1),e[27]||(e[27]=M(" قطعة ",-1))])):w("",!0)]),t("div",null,[e[29]||(e[29]=t("label",{class:"block text-sm font-medium mb-2"},"الكمية التالفة *",-1)),S(t("input",{"onUpdate:modelValue":e[6]||(e[6]=s=>d.value.quantity=s),type:"number",min:"1",max:((i=m.value)==null?void 0:i.stock_quantity)||999,required:"",class:"input",placeholder:"أدخل الكمية التالفة"},null,8,be),[[E,d.value.quantity,void 0,{number:!0}]]),e[30]||(e[30]=t("p",{class:"text-xs text-red-600 mt-1"}," ⚠️ سيتم خصم هذه الكمية من المخزون تلقائياً ",-1))]),t("div",null,[e[32]||(e[32]=t("label",{class:"block text-sm font-medium mb-2"},"نوع التلف *",-1)),S(t("select",{"onUpdate:modelValue":e[7]||(e[7]=s=>d.value.damage_type=s),required:"",class:"input"},[...e[31]||(e[31]=[st('<option value="">اختر نوع التلف</option><option value="expired">منتهي الصلاحية</option><option value="broken">مكسور/تالف</option><option value="defective">معيب من المصنع</option><option value="water_damage">تلف بسبب الماء</option><option value="other">أخرى</option>',6)])],512),[[et,d.value.damage_type]])]),t("div",null,[e[33]||(e[33]=t("label",{class:"block text-sm font-medium mb-2"},"ملاحظات",-1)),S(t("textarea",{"onUpdate:modelValue":e[8]||(e[8]=s=>d.value.notes=s),rows:"3",class:"input",placeholder:"أضف أي ملاحظات إضافية..."},null,512),[[E,d.value.notes]])]),t("div",{class:"flex gap-3 justify-end mt-6"},[t("button",{type:"button",onClick:I,class:"btn btn-secondary"},"إلغاء"),e[34]||(e[34]=t("button",{type:"submit",class:"btn btn-danger"},"تسجيل التلف",-1))])],32)])])):w("",!0)])}}};export{Me as default};
