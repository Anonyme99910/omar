import{b as he,r as l,g as V,h as xe,c as d,o as c,d as t,j,e as f,k as b,v as g,l as r,F as I,m as N,t as v,s as W,x as _e,w as ae,y as h}from"./index-DaDqu3Du.js";import{f as z,t as L}from"./numbers-BTmV-EI5.js";import{S as we}from"./search-B1ss7DFm.js";import{P as Ce}from"./package-kHuKp2ba.js";import{c as oe}from"./createLucideIcon-Q_oOX2Bc.js";import{P as ke}from"./plus-BAH27pEy.js";import{T as qe}from"./trash-2-Su1nV_VB.js";import{U as Pe}from"./user-plus-T05e9RPX.js";/**
 * @license lucide-vue-next v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Se=oe("MinusIcon",[["path",{d:"M5 12h14",key:"1ays0h"}]]);/**
 * @license lucide-vue-next v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const $e=oe("ShoppingCartIcon",[["circle",{cx:"8",cy:"21",r:"1",key:"jimo8o"}],["circle",{cx:"19",cy:"21",r:"1",key:"13723u"}],["path",{d:"M2.05 2.05h2l2.66 12.42a2 2 0 0 0 2 1.58h9.78a2 2 0 0 0 1.95-1.57l1.65-7.43H5.12",key:"9zh506"}]]),Me={class:"grid grid-cols-1 lg:grid-cols-3 gap-6"},Fe={class:"lg:col-span-2 space-y-4"},Ve={class:"card"},je={class:"relative"},ze={key:0,class:"absolute left-12 top-3.5"},Le={class:"grid grid-cols-2 md:grid-cols-3 gap-4"},Ue=["onClick"],Te={class:"aspect-square bg-gray-100 rounded-lg mb-3 flex items-center justify-center"},De={class:"font-bold text-gray-900 mb-1 truncate"},Ie={class:"text-sm text-gray-500 mb-2"},Ne={class:"flex items-center justify-between"},Ae={class:"text-lg font-bold text-primary-600"},Qe={class:"space-y-4"},Be={class:"card sticky top-24"},Ee={class:"text-xl font-bold mb-4 flex items-center gap-2"},We={class:"space-y-3 mb-4 max-h-64 overflow-y-auto"},He={key:0,class:"text-center py-8 text-gray-500"},Oe={class:"flex-1"},Re={class:"font-medium text-sm"},Ge={class:"text-xs text-gray-500"},Je={class:"flex items-center gap-2"},Ke=["onClick"],Xe={class:"w-8 text-center font-bold"},Ye=["onClick"],Ze=["onClick"],et={class:"mb-4"},tt={class:"flex gap-2"},st={class:"flex-1 relative"},at={key:0,class:"absolute z-50 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-y-auto"},ot=["onMousedown"],nt={class:"font-medium"},lt={class:"text-sm text-gray-600"},rt={class:"border-t pt-4 space-y-2"},ut={class:"flex justify-between text-sm"},it={class:"font-bold"},dt={class:"flex justify-between text-sm"},ct={class:"flex justify-between text-sm"},vt={class:"flex justify-between text-lg font-bold border-t pt-2"},pt={class:"text-primary-600"},mt={class:"flex justify-between text-sm bg-blue-50 p-2 rounded"},yt=["placeholder"],ft={key:0,class:"flex justify-between text-sm text-red-600 font-bold"},bt={class:"mt-4"},gt={class:"grid grid-cols-3 gap-2"},ht=["onClick"],xt={class:"mt-4 space-y-2"},_t=["disabled"],wt={class:"bg-white rounded-xl p-6 w-full max-w-md"},Ct={class:"flex gap-3"},zt={__name:"POS",setup(kt){const u=he(),m=l([]),U=l([]),y=l([]),i=l([]),T=l(""),x=l(""),_=l("");l("");const w=l(0),C=l(0),P=l(null),A=l("cash"),S=l(!1),$=l(!1),Q=l(!1);let B=null;const k=l({name:"",phone:""}),ne=[{value:"cash",label:"نقدي"},{value:"card",label:"بطاقة"},{value:"transfer",label:"تحويل"}],le=V(()=>T.value?m.value:m.value.slice(0,12)),H=V(()=>{if(!x.value)return y.value;const a=x.value.toLowerCase().trim();return y.value.filter(e=>{const s=e.name.toLowerCase(),n=e.phone.toString();if(s.includes(a)||n.includes(a))return!0;let o=0;for(let p=0;p<s.length&&o<a.length;p++)s[p]===a[o]&&o++;return o===a.length}).slice(0,10)}),O=V(()=>i.value.reduce((a,e)=>a+e.unit_price*e.quantity,0)),M=V(()=>O.value+C.value-w.value),R=V(()=>{const a=P.value||M.value;return Math.max(0,M.value-a)}),re=()=>{B&&clearTimeout(B),Q.value=!0,B=setTimeout(async()=>{await ue(),Q.value=!1},300)},ue=async()=>{const a=T.value.trim();if(!a){m.value=U.value.slice(0,12);return}const e=a.toLowerCase(),s=U.value.filter(n=>{var Y,Z,ee,te,se;const o=n.name_ar.toLowerCase(),p=((Y=n.barcode)==null?void 0:Y.toLowerCase())||"",F=((ee=(Z=n.category)==null?void 0:Z.name_ar)==null?void 0:ee.toLowerCase())||"",D=((se=(te=n.brand)==null?void 0:te.name_ar)==null?void 0:se.toLowerCase())||"";if(o.includes(e)||p.includes(e)||F.includes(e)||D.includes(e))return!0;let q=0;for(let E=0;E<o.length&&q<e.length;E++)o[E]===e[q]&&q++;return q===e.length});if(m.value=s,s.length===0&&a.length>=2)try{const n=await h.getProducts({search:a});m.value=n.data.data||n.data||[]}catch(n){console.error("Search error:",n)}},ie=()=>{$.value=!0},G=a=>{if(_.value=a,a){const e=y.value.find(s=>s.id===a);e&&(x.value=`${e.name} - ${L(e.phone)}`)}else x.value="عميل عادي";$.value=!1},de=()=>{setTimeout(()=>{$.value=!1},200)},J=a=>{const e=y.value.find(n=>n.id===_.value),s=(e==null?void 0:e.segment)||"قطاعي";return parseFloat(s==="جملة"?a.price_جملة:s==="صفحة"?a.price_صفحة:a.price_قطاعي)},ce=a=>{if(a.quantity===0){u.error("المنتج غير متوفر في المخزون");return}const e=i.value.find(s=>s.product.id===a.id);if(e){if(e.quantity>=a.quantity){u.error("الكمية المطلوبة غير متوفرة");return}e.quantity++}else i.value.push({product:a,quantity:1,unit_price:J(a)});u.success("تم إضافة المنتج للسلة")},ve=a=>{if(a.quantity>=a.product.quantity){u.error("الكمية المطلوبة غير متوفرة");return}a.quantity++},pe=a=>{a.quantity>1?a.quantity--:K(a)},K=a=>{i.value=i.value.filter(e=>e.product.id!==a.product.id)},me=()=>{i.value.length!==0&&confirm("هل أنت متأكد من مسح السلة؟")&&(i.value=[],w.value=0,C.value=0)},ye=async()=>{try{const a=await h.createCustomer(k.value);u.success("تم إضافة العميل بنجاح"),y.value.push(a.data),_.value=a.data.id,S.value=!1,k.value={name:"",phone:""}}catch{u.error("فشل إضافة العميل")}},fe=async()=>{var e,s,n;if(i.value.length===0)return;const a={customer_id:_.value||null,items:i.value.map(o=>({product_id:o.product.id,quantity:o.quantity,unit_price:o.unit_price})),tax:C.value,discount:w.value,paid_amount:P.value||M.value,payment_method:A.value};try{const o=await h.createSale(a),p=L(o.data.invoice_number);u.success(`تم إنشاء الفاتورة ${p}`);const F=[];if(confirm("هل تريد تحميل الفاتورة PDF؟"))try{await h.downloadInvoicePdf(o.data.id),u.success("تم تحميل الفاتورة بنجاح")}catch(D){console.error("PDF Error:",D),u.error("فشل تحميل الفاتورة PDF")}(e=o.data.customer)!=null&&e.phone&&confirm("هل تريد مشاركة الفاتورة عبر واتساب؟")&&be(o.data),i.value=[],w.value=0,C.value=0,P.value=null,_.value="",X()}catch(o){u.error(((n=(s=o.response)==null?void 0:s.data)==null?void 0:n.error)||"فشل إنشاء الفاتورة")}},be=async a=>{var e,s,n;try{const o=await h.getWhatsAppMessage(a.id),{message:p,phone:F}=o.data;if(!F){u.error("لا يوجد رقم هاتف للعميل");return}const q=`https://wa.me/${F.replace(/[^0-9]/g,"")}?text=${encodeURIComponent(p)}`;window.open(q,"_blank"),u.success("تم فتح واتساب بنجاح")}catch(o){console.error("WhatsApp Error:",o),console.error("Error details:",(e=o.response)==null?void 0:e.data),u.error("فشل مشاركة الفاتورة عبر واتساب: "+(((n=(s=o.response)==null?void 0:s.data)==null?void 0:n.message)||o.message))}},X=async()=>{try{const a=await h.getProducts(),e=a.data.data||a.data||[];U.value=e,m.value=e}catch(a){console.error("Failed to load products:",a),U.value=[],m.value=[]}},ge=async()=>{try{const a=await h.getCustomers();y.value=a.data.data||a.data||[]}catch(a){console.error("Failed to load customers:",a),y.value=[]}};return xe(()=>{X(),ge()}),(a,e)=>(c(),d("div",Me,[t("div",Fe,[t("div",Ve,[t("div",je,[f(t("input",{"onUpdate:modelValue":e[0]||(e[0]=s=>T.value=s),onInput:re,type:"text",placeholder:"ابحث بالاسم أو الباركود أو الفئة...",class:"input pl-10 text-lg",autofocus:""},null,544),[[g,T.value]]),b(r(we),{class:"absolute left-3 top-3.5 text-gray-400",size:24}),Q.value?(c(),d("div",ze,[...e[12]||(e[12]=[t("div",{class:"animate-spin rounded-full h-5 w-5 border-b-2 border-primary-600"},null,-1)])])):j("",!0)])]),t("div",Le,[(c(!0),d(I,null,N(le.value,s=>(c(),d("div",{key:s.id,onClick:n=>ce(s),class:"card hover:shadow-lg cursor-pointer transition-all hover:scale-105"},[t("div",Te,[b(r(Ce),{size:48,class:"text-gray-400"})]),t("h4",De,v(s.name_ar),1),t("p",Ie,v(s.volume_ml),1),t("div",Ne,[t("span",Ae,v(r(z)(J(s))),1),t("span",{class:W(["text-xs badge",s.quantity>0?"badge-success":"badge-danger"])},v(r(L)(s.quantity))+" قطعة ",3)])],8,Ue))),128))])]),t("div",Qe,[t("div",Be,[t("h3",Ee,[b(r($e),{size:24}),e[13]||(e[13]=_e(" سلة المشتريات ",-1))]),t("div",We,[i.value.length===0?(c(),d("div",He," السلة فارغة ")):j("",!0),(c(!0),d(I,null,N(i.value,s=>(c(),d("div",{key:s.product.id,class:"flex items-center gap-3 p-3 bg-gray-50 rounded-lg"},[t("div",Oe,[t("p",Re,v(s.product.name_ar),1),t("p",Ge,v(r(z)(s.unit_price)),1)]),t("div",Je,[t("button",{onClick:n=>pe(s),class:"w-7 h-7 rounded bg-gray-200 hover:bg-gray-300"},[b(r(Se),{size:16,class:"mx-auto"})],8,Ke),t("span",Xe,v(r(L)(s.quantity)),1),t("button",{onClick:n=>ve(s),class:"w-7 h-7 rounded bg-gray-200 hover:bg-gray-300"},[b(r(ke),{size:16,class:"mx-auto"})],8,Ye)]),t("button",{onClick:n=>K(s),class:"text-red-600 hover:text-red-800"},[b(r(qe),{size:18})],8,Ze)]))),128))]),t("div",et,[e[15]||(e[15]=t("label",{class:"block text-sm font-medium mb-2"},"العميل (اختياري)",-1)),t("div",tt,[t("div",st,[f(t("input",{"onUpdate:modelValue":e[1]||(e[1]=s=>x.value=s),onInput:ie,onFocus:e[2]||(e[2]=s=>$.value=!0),onBlur:de,type:"text",placeholder:"ابحث عن عميل أو اختر عميل عادي...",class:"input"},null,544),[[g,x.value]]),$.value&&H.value.length>0?(c(),d("div",at,[t("div",{onMousedown:e[3]||(e[3]=s=>G("")),class:"px-4 py-2 hover:bg-gray-100 cursor-pointer border-b"},[...e[14]||(e[14]=[t("span",{class:"font-medium"},"عميل عادي",-1)])],32),(c(!0),d(I,null,N(H.value,s=>(c(),d("div",{key:s.id,onMousedown:n=>G(s.id),class:W(["px-4 py-2 hover:bg-primary-50 cursor-pointer transition-colors",{"bg-primary-100":_.value===s.id}])},[t("div",nt,v(s.name),1),t("div",lt,v(r(L)(s.phone)),1)],42,ot))),128))])):j("",!0)]),t("button",{onClick:e[4]||(e[4]=s=>S.value=!0),class:"btn btn-secondary"},[b(r(Pe),{size:18})])])]),t("div",rt,[t("div",ut,[e[16]||(e[16]=t("span",null,"المجموع الفرعي:",-1)),t("span",it,v(r(z)(O.value)),1)]),t("div",dt,[e[17]||(e[17]=t("span",null,"الخصم:",-1)),f(t("input",{"onUpdate:modelValue":e[5]||(e[5]=s=>w.value=s),type:"number",step:"0.01",class:"input w-32 text-left py-1"},null,512),[[g,w.value,void 0,{number:!0}]])]),t("div",ct,[e[18]||(e[18]=t("span",null,"الضريبة:",-1)),f(t("input",{"onUpdate:modelValue":e[6]||(e[6]=s=>C.value=s),type:"number",step:"0.01",class:"input w-32 text-left py-1"},null,512),[[g,C.value,void 0,{number:!0}]])]),t("div",vt,[e[19]||(e[19]=t("span",null,"الإجمالي:",-1)),t("span",pt,v(r(z)(M.value)),1)]),t("div",mt,[e[20]||(e[20]=t("span",null,"المبلغ المدفوع:",-1)),f(t("input",{"onUpdate:modelValue":e[7]||(e[7]=s=>P.value=s),type:"number",step:"0.01",placeholder:M.value.toString(),class:"input w-32 text-left py-1"},null,8,yt),[[g,P.value,void 0,{number:!0}]])]),R.value>0?(c(),d("div",ft,[e[21]||(e[21]=t("span",null,"المتبقي:",-1)),t("span",null,v(r(z)(R.value)),1)])):j("",!0)]),t("div",bt,[e[22]||(e[22]=t("label",{class:"block text-sm font-medium mb-2"},"طريقة الدفع",-1)),t("div",gt,[(c(),d(I,null,N(ne,s=>t("button",{key:s.value,onClick:n=>A.value=s.value,class:W([A.value===s.value?"bg-primary-600 text-white":"bg-gray-100","py-2 rounded-lg font-medium transition-all"])},v(s.label),11,ht)),64))])]),t("div",xt,[t("button",{onClick:fe,disabled:i.value.length===0,class:"btn btn-success w-full py-3 text-lg"}," إتمام البيع ",8,_t),t("button",{onClick:me,class:"btn btn-secondary w-full"}," مسح السلة ")])])]),S.value?(c(),d("div",{key:0,class:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",onClick:e[11]||(e[11]=ae(s=>S.value=!1,["self"]))},[t("div",wt,[e[26]||(e[26]=t("h3",{class:"text-2xl font-bold mb-4"},"إضافة عميل",-1)),t("form",{onSubmit:ae(ye,["prevent"]),class:"space-y-4"},[t("div",null,[e[23]||(e[23]=t("label",{class:"block text-sm font-medium mb-2"},"الاسم *",-1)),f(t("input",{"onUpdate:modelValue":e[8]||(e[8]=s=>k.value.name=s),type:"text",required:"",class:"input"},null,512),[[g,k.value.name]])]),t("div",null,[e[24]||(e[24]=t("label",{class:"block text-sm font-medium mb-2"},"رقم الهاتف *",-1)),f(t("input",{"onUpdate:modelValue":e[9]||(e[9]=s=>k.value.phone=s),type:"tel",required:"",class:"input"},null,512),[[g,k.value.phone]])]),t("div",Ct,[t("button",{type:"button",onClick:e[10]||(e[10]=s=>S.value=!1),class:"btn btn-secondary flex-1"},"إلغاء"),e[25]||(e[25]=t("button",{type:"submit",class:"btn btn-primary flex-1"},"حفظ",-1))])],32)])])):j("",!0)]))}};export{zt as default};
