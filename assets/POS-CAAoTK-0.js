import{b as Ce,r as l,g as U,h as qe,c as p,o as u,d as t,e as b,k as g,v as x,l as c,F as M,m as I,t as r,s as E,x as se,j as T,p as Pe,w as ae,y as h}from"./index-mWySpl0M.js";import{f as V,t as W}from"./numbers-BTmV-EI5.js";import{S as oe}from"./search-CwSrVE3Q.js";import{U as Se}from"./user-plus-DqE1Klk1.js";import{P as je}from"./package-HWpWSAOC.js";import{c as ne}from"./createLucideIcon-B63S5AJZ.js";import{P as $e}from"./plus-xSDfNm6B.js";import{T as Ue}from"./trash-2-BbRDRxrI.js";/**
 * @license lucide-vue-next v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ve=ne("MinusIcon",[["path",{d:"M5 12h14",key:"1ays0h"}]]);/**
 * @license lucide-vue-next v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ze=ne("ShoppingCartIcon",[["circle",{cx:"8",cy:"21",r:"1",key:"jimo8o"}],["circle",{cx:"19",cy:"21",r:"1",key:"13723u"}],["path",{d:"M2.05 2.05h2l2.66 12.42a2 2 0 0 0 2 1.58h9.78a2 2 0 0 0 1.95-1.57l1.65-7.43H5.12",key:"9zh506"}]]),Fe={key:0,class:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"},Le={class:"bg-white rounded-2xl shadow-2xl p-8 w-full max-w-2xl mx-4 max-h-[90vh] overflow-y-auto"},Me={class:"mb-6"},Ie={class:"relative"},Te={class:"space-y-3 max-h-96 overflow-y-auto mb-6"},Ne=["onClick"],Ae={class:"flex items-center justify-between"},De={class:"font-bold text-lg text-gray-900"},Qe={class:"text-sm text-gray-600"},Be={key:1,class:"grid grid-cols-1 lg:grid-cols-3 gap-6"},Ee={class:"lg:col-span-2 space-y-4"},We={class:"card"},Oe={class:"relative"},Je={key:0,class:"absolute left-12 top-3.5"},He={class:"grid grid-cols-2 md:grid-cols-3 gap-4"},Re=["onClick"],Ge={class:"aspect-square bg-gray-100 rounded-lg mb-3 flex items-center justify-center overflow-hidden"},Ke=["src","alt"],Xe={class:"font-bold text-gray-900 mb-1 truncate"},Ye={class:"text-sm text-gray-500 mb-2"},Ze={class:"flex items-center justify-between"},et={class:"text-lg font-bold text-primary-600"},tt={class:"space-y-4"},st={class:"card sticky top-24"},at={class:"mb-4 p-3 bg-primary-50 rounded-lg border border-primary-200"},ot={class:"flex items-center justify-between mb-2"},nt={class:"font-bold text-gray-900"},lt={class:"text-xs text-gray-600"},rt={class:"text-xl font-bold mb-4 flex items-center gap-2"},it={class:"space-y-3 mb-4 max-h-64 overflow-y-auto"},ut={key:0,class:"text-center py-8 text-gray-500"},ct={class:"flex-1"},dt={class:"font-medium text-sm"},pt={class:"text-xs text-gray-500"},vt={class:"flex items-center gap-2"},mt=["onClick"],yt={class:"w-8 text-center font-bold"},ft=["onClick"],bt=["onClick"],gt={class:"border-t pt-4 space-y-2"},xt={class:"flex justify-between text-sm"},ht={class:"font-bold"},_t={class:"flex justify-between text-sm"},wt={class:"flex justify-between text-sm"},kt={class:"flex justify-between text-lg font-bold border-t pt-2"},Ct={class:"text-primary-600"},qt={class:"flex justify-between text-sm bg-blue-50 p-2 rounded"},Pt=["placeholder"],St={key:0,class:"flex justify-between text-sm text-red-600 font-bold"},jt={class:"mt-4"},$t={class:"grid grid-cols-3 gap-2"},Ut=["onClick"],Vt={class:"mt-4 space-y-2"},zt=["disabled"],Ft={class:"bg-white rounded-xl p-6 w-full max-w-md"},Lt={class:"flex gap-3"},Wt={__name:"POS",setup(Mt){const d=Ce(),y=l([]),z=l([]),f=l([]),i=l([]),F=l(""),_=l(""),m=l(null),N=l(""),w=l(0),k=l(0),P=l(null),A=l("cash"),S=l(!1);l(!1);const D=l(!1);let Q=null;const C=l({name:"",phone:""}),le=[{value:"cash",label:"نقدي"},{value:"card",label:"بطاقة"},{value:"transfer",label:"تحويل"}],re=U(()=>F.value?y.value:y.value.slice(0,12)),ie=U(()=>{if(!_.value)return f.value;const a=_.value.toLowerCase().trim();return f.value.filter(e=>{const s=e.name.toLowerCase(),n=e.phone.toString();if(s.includes(a)||n.includes(a))return!0;let o=0;for(let v=0;v<s.length&&o<a.length;v++)s[v]===a[o]&&o++;return o===a.length}).slice(0,10)}),O=U(()=>i.value.reduce((a,e)=>a+e.unit_price*e.quantity,0)),j=U(()=>O.value+k.value-w.value),J=U(()=>{const a=P.value||j.value;return Math.max(0,j.value-a)}),ue=()=>{Q&&clearTimeout(Q),D.value=!0,Q=setTimeout(async()=>{await ce(),D.value=!1},300)},ce=async()=>{const a=F.value.trim();if(!a){y.value=z.value.slice(0,12);return}const e=a.toLowerCase(),s=z.value.filter(n=>{var X,Y,Z,ee,te;const o=n.name_ar.toLowerCase(),v=((X=n.barcode)==null?void 0:X.toLowerCase())||"",$=((Z=(Y=n.category)==null?void 0:Y.name_ar)==null?void 0:Z.toLowerCase())||"",L=((te=(ee=n.brand)==null?void 0:ee.name_ar)==null?void 0:te.toLowerCase())||"";if(o.includes(e)||v.includes(e)||$.includes(e)||L.includes(e))return!0;let q=0;for(let B=0;B<o.length&&q<e.length;B++)o[B]===e[q]&&q++;return q===e.length});if(y.value=s,s.length===0&&a.length>=2)try{const n=await h.getProducts({search:a});y.value=n.data.data||n.data||[]}catch(n){console.error("Search error:",n)}},de=()=>{},pe=a=>{if(!a)return"";const s=JSON.parse(a)[0];return s.startsWith("data:")?s:`http://localhost/parfumes/backend/public${s}`},ve=a=>{if(!a&&a!==0)return"";const e=String(a).trim();return/\bml\b/i.test(e)||e.includes("مل")?e:`${e} مل`},H=a=>{const e=f.value.find(n=>n.id===m.value),s=(e==null?void 0:e.segment)||"قطاعي";return parseFloat(s==="جملة"?a.price_جملة:s==="صفحة"?a.price_صفحة:a.price_قطاعي)},me=a=>{if(a.quantity===0){d.error("المنتج غير متوفر في المخزون");return}const e=i.value.find(s=>s.product.id===a.id);if(e){if(e.quantity>=a.quantity){d.error("الكمية المطلوبة غير متوفرة");return}e.quantity++}else i.value.push({product:a,quantity:1,unit_price:H(a)});d.success("تم إضافة المنتج للسلة")},ye=a=>{if(a.quantity>=a.product.quantity){d.error("الكمية المطلوبة غير متوفرة");return}a.quantity++},fe=a=>{a.quantity>1?a.quantity--:R(a)},R=a=>{i.value=i.value.filter(e=>e.product.id!==a.product.id)},be=()=>{i.value.length!==0&&confirm("هل أنت متأكد من مسح السلة؟")&&(i.value=[],w.value=0,k.value=0)},ge=async()=>{try{const a=await h.createCustomer(C.value);d.success("تم إضافة العميل بنجاح"),f.value.push(a.data),m.value=a.data.id,S.value=!1,C.value={name:"",phone:""}}catch{d.error("فشل إضافة العميل")}},xe=async()=>{var e,s,n;if(i.value.length===0)return;const a={customer_id:m.value||null,items:i.value.map(o=>({product_id:o.product.id,quantity:o.quantity,unit_price:o.unit_price})),tax:k.value,discount:w.value,paid_amount:P.value||j.value,payment_method:A.value};try{const o=await h.createSale(a),v=W(o.data.invoice_number);d.success(`تم إنشاء الفاتورة ${v}`);const $=[];if(confirm("هل تريد تحميل الفاتورة PDF؟"))try{await h.downloadInvoicePdf(o.data.id),d.success("تم تحميل الفاتورة بنجاح")}catch(L){console.error("PDF Error:",L),d.error("فشل تحميل الفاتورة PDF")}(e=o.data.customer)!=null&&e.phone&&confirm("هل تريد مشاركة الفاتورة عبر واتساب؟")&&he(o.data),i.value=[],w.value=0,k.value=0,P.value=null,G()}catch(o){d.error(((n=(s=o.response)==null?void 0:s.data)==null?void 0:n.error)||"فشل إنشاء الفاتورة")}},he=async a=>{var e,s,n;try{const o=await h.getWhatsAppMessage(a.id),{message:v,phone:$}=o.data;if(!$){d.error("لا يوجد رقم هاتف للعميل");return}const q=`https://wa.me/${$.replace(/[^0-9]/g,"")}?text=${encodeURIComponent(v)}`;window.open(q,"_blank"),d.success("تم فتح واتساب بنجاح")}catch(o){console.error("WhatsApp Error:",o),console.error("Error details:",(e=o.response)==null?void 0:e.data),d.error("فشل مشاركة الفاتورة عبر واتساب: "+(((n=(s=o.response)==null?void 0:s.data)==null?void 0:n.message)||o.message))}},G=async()=>{try{const a=await h.getProducts(),e=a.data.data||a.data||[];z.value=e,y.value=e}catch(a){console.error("Failed to load products:",a),z.value=[],y.value=[]}},_e=async()=>{try{const a=await h.getCustomers();f.value=a.data.data||a.data||[]}catch(a){console.error("Failed to load customers:",a),f.value=[]}},K=(a,e)=>{m.value=a,N.value=e,_.value="",d.success(`تم اختيار: ${e}`)},we=()=>{i.value.length>0&&!confirm("سيتم مسح السلة الحالية. هل تريد المتابعة؟")||(i.value=[],m.value=null,N.value="",_.value="")},ke=()=>{if(!m.value)return"قطاعي";const a=f.value.find(e=>e.id===m.value);return(a==null?void 0:a.segment)||"قطاعي"};return qe(()=>{G(),_e()}),(a,e)=>m.value?(u(),p("div",Be,[t("div",Ee,[t("div",We,[t("div",Oe,[b(t("input",{"onUpdate:modelValue":e[3]||(e[3]=s=>F.value=s),onInput:ue,type:"text",placeholder:"ابحث بالاسم أو الباركود أو الفئة...",class:"input pl-10 text-lg",autofocus:""},null,544),[[x,F.value]]),g(c(oe),{class:"absolute left-3 top-3.5 text-gray-400",size:24}),D.value?(u(),p("div",Je,[...e[14]||(e[14]=[t("div",{class:"animate-spin rounded-full h-5 w-5 border-b-2 border-primary-600"},null,-1)])])):T("",!0)])]),t("div",He,[(u(!0),p(M,null,I(re.value,s=>(u(),p("div",{key:s.id,onClick:n=>me(s),class:"card hover:shadow-lg cursor-pointer transition-all hover:scale-105"},[t("div",Ge,[s.photos&&JSON.parse(s.photos)[0]?(u(),p("img",{key:0,src:pe(s.photos),alt:s.name_ar,class:"w-full h-full object-cover"},null,8,Ke)):(u(),Pe(c(je),{key:1,size:48,class:"text-gray-400"}))]),t("h4",Xe,r(s.name_ar),1),t("p",Ye,r(ve(s.volume_ml)),1),t("div",Ze,[t("span",et,r(c(V)(H(s))),1),t("span",{class:E(["text-xs badge",s.quantity>0?"badge-success":"badge-danger"])},r(c(W)(s.quantity))+" قطعة ",3)])],8,Re))),128))])]),t("div",tt,[t("div",st,[t("div",at,[t("div",ot,[t("div",null,[e[15]||(e[15]=t("p",{class:"text-sm text-gray-600"},"العميل الحالي",-1)),t("p",nt,r(N.value),1)]),t("button",{onClick:we,class:"text-sm text-primary-600 hover:text-primary-800 font-medium"}," تغيير ")]),t("div",lt," السعر: "+r(ke()),1)]),t("h3",rt,[g(c(ze),{size:24}),e[16]||(e[16]=se(" سلة المشتريات ",-1))]),t("div",it,[i.value.length===0?(u(),p("div",ut," السلة فارغة ")):T("",!0),(u(!0),p(M,null,I(i.value,s=>(u(),p("div",{key:s.product.id,class:"flex items-center gap-3 p-3 bg-gray-50 rounded-lg"},[t("div",ct,[t("p",dt,r(s.product.name_ar),1),t("p",pt,r(c(V)(s.unit_price)),1)]),t("div",vt,[t("button",{onClick:n=>fe(s),class:"w-7 h-7 rounded bg-gray-200 hover:bg-gray-300"},[g(c(Ve),{size:16,class:"mx-auto"})],8,mt),t("span",yt,r(c(W)(s.quantity)),1),t("button",{onClick:n=>ye(s),class:"w-7 h-7 rounded bg-gray-200 hover:bg-gray-300"},[g(c($e),{size:16,class:"mx-auto"})],8,ft)]),t("button",{onClick:n=>R(s),class:"text-red-600 hover:text-red-800"},[g(c(Ue),{size:18})],8,bt)]))),128))]),t("div",gt,[t("div",xt,[e[17]||(e[17]=t("span",null,"المجموع الفرعي:",-1)),t("span",ht,r(c(V)(O.value)),1)]),t("div",_t,[e[18]||(e[18]=t("span",null,"الخصم:",-1)),b(t("input",{"onUpdate:modelValue":e[4]||(e[4]=s=>w.value=s),type:"number",step:"0.01",class:"input w-32 text-left py-1"},null,512),[[x,w.value,void 0,{number:!0}]])]),t("div",wt,[e[19]||(e[19]=t("span",null,"الضريبة:",-1)),b(t("input",{"onUpdate:modelValue":e[5]||(e[5]=s=>k.value=s),type:"number",step:"0.01",class:"input w-32 text-left py-1"},null,512),[[x,k.value,void 0,{number:!0}]])]),t("div",kt,[e[20]||(e[20]=t("span",null,"الإجمالي:",-1)),t("span",Ct,r(c(V)(j.value)),1)]),t("div",qt,[e[21]||(e[21]=t("span",null,"المبلغ المدفوع:",-1)),b(t("input",{"onUpdate:modelValue":e[6]||(e[6]=s=>P.value=s),type:"number",step:"0.01",placeholder:j.value.toString(),class:"input w-32 text-left py-1"},null,8,Pt),[[x,P.value,void 0,{number:!0}]])]),J.value>0?(u(),p("div",St,[e[22]||(e[22]=t("span",null,"المتبقي:",-1)),t("span",null,r(c(V)(J.value)),1)])):T("",!0)]),t("div",jt,[e[23]||(e[23]=t("label",{class:"block text-sm font-medium mb-2"},"طريقة الدفع",-1)),t("div",$t,[(u(),p(M,null,I(le,s=>t("button",{key:s.value,onClick:n=>A.value=s.value,class:E([A.value===s.value?"bg-primary-600 text-white":"bg-gray-100","py-2 rounded-lg font-medium transition-all"])},r(s.label),11,Ut)),64))])]),t("div",Vt,[t("button",{onClick:xe,disabled:i.value.length===0,class:"btn btn-success w-full py-3 text-lg"}," إتمام البيع ",8,zt),t("button",{onClick:be,class:"btn btn-secondary w-full"}," مسح السلة ")])])]),S.value?(u(),p("div",{key:0,class:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",onClick:e[10]||(e[10]=ae(s=>S.value=!1,["self"]))},[t("div",Ft,[e[27]||(e[27]=t("h3",{class:"text-2xl font-bold mb-4"},"إضافة عميل",-1)),t("form",{onSubmit:ae(ge,["prevent"]),class:"space-y-4"},[t("div",null,[e[24]||(e[24]=t("label",{class:"block text-sm font-medium mb-2"},"الاسم *",-1)),b(t("input",{"onUpdate:modelValue":e[7]||(e[7]=s=>C.value.name=s),type:"text",required:"",class:"input"},null,512),[[x,C.value.name]])]),t("div",null,[e[25]||(e[25]=t("label",{class:"block text-sm font-medium mb-2"},"رقم الهاتف *",-1)),b(t("input",{"onUpdate:modelValue":e[8]||(e[8]=s=>C.value.phone=s),type:"tel",required:"",class:"input"},null,512),[[x,C.value.phone]])]),t("div",Lt,[t("button",{type:"button",onClick:e[9]||(e[9]=s=>S.value=!1),class:"btn btn-secondary flex-1"},"إلغاء"),e[26]||(e[26]=t("button",{type:"submit",class:"btn btn-primary flex-1"},"حفظ",-1))])],32)])])):T("",!0)])):(u(),p("div",Fe,[t("div",Le,[e[13]||(e[13]=t("div",{class:"text-center mb-8"},[t("h2",{class:"text-3xl font-bold text-gray-900 mb-2"},"مرحباً بك في نقطة البيع"),t("p",{class:"text-gray-600"},"اختر العميل للمتابعة")],-1)),t("div",Me,[t("div",Ie,[b(t("input",{"onUpdate:modelValue":e[0]||(e[0]=s=>_.value=s),onInput:de,type:"text",placeholder:"ابحث عن عميل بالاسم أو الهاتف...",class:"input pl-10 text-lg",autofocus:""},null,544),[[x,_.value]]),g(c(oe),{class:"absolute left-3 top-3.5 text-gray-400",size:24})])]),t("div",Te,[t("button",{onClick:e[1]||(e[1]=s=>K(null,"عميل عادي")),class:"w-full p-4 bg-gradient-to-r from-gray-100 to-gray-200 hover:from-gray-200 hover:to-gray-300 rounded-xl text-right transition-all border-2 border-transparent hover:border-primary-500"},[...e[11]||(e[11]=[t("div",{class:"flex items-center justify-between"},[t("div",null,[t("p",{class:"font-bold text-lg text-gray-900"},"عميل عادي"),t("p",{class:"text-sm text-gray-600"},"سعر قطاعي")]),t("div",{class:"bg-primary-100 text-primary-700 px-3 py-1 rounded-full text-sm font-medium"}," قطاعي ")],-1)])]),(u(!0),p(M,null,I(ie.value,s=>(u(),p("button",{key:s.id,onClick:n=>K(s.id,s.name),class:"w-full p-4 bg-white hover:bg-gray-50 rounded-xl text-right transition-all border-2 border-gray-200 hover:border-primary-500"},[t("div",Ae,[t("div",null,[t("p",De,r(s.name),1),t("p",Qe,r(s.phone),1)]),t("div",{class:E(["px-3 py-1 rounded-full text-sm font-medium",{"bg-blue-100 text-blue-700":s.segment==="جملة","bg-green-100 text-green-700":s.segment==="قطاعي","bg-purple-100 text-purple-700":s.segment==="صفحة"}])},r(s.segment),3)])],8,Ne))),128))]),t("button",{onClick:e[2]||(e[2]=s=>S.value=!0),class:"w-full btn btn-primary flex items-center justify-center gap-2"},[g(c(Se),{size:20}),e[12]||(e[12]=se(" إضافة عميل جديد ",-1))])])]))}};export{Wt as default};
